<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>مای‌ده — بازار و هواشناسی اهواز (نسخه نهایی)</title>

<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#f6fff6; --text:#12321a; --card:#ffffff; --muted:#eef7ee;
  --primary:#2e7d32; --accent:#74c37a; --danger:#d9534f; --border:#dfe7df;
  --glass: rgba(255,255,255,0.6);
  --shadow: 0 10px 30px rgba(0,0,0,0.08);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Vazirmatn',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
a{color:var(--primary);text-decoration:none}
button{cursor:pointer;font-family:inherit}
header{position:sticky;top:0;z-index:140;background:linear-gradient(90deg,var(--primary),#1b5e20);color:#fff;padding:12px 16px;box-shadow:var(--shadow)}
.header-row{display:flex;align-items:center;justify-content:space-between;gap:10px;max-width:1180px;margin:0 auto}
.brand{display:flex;align-items:center;gap:10px}
.brand h1{margin:0;font-size:20px;font-weight:800}
.actions{display:flex;align-items:center;gap:8px}
.select{background:rgba(255,255,255,0.12);color:#fff;border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:8px}
.icon-btn{background:rgba(255,255,255,0.12);color:#fff;border:none;padding:8px;border-radius:10px;cursor:pointer}
.ticker{margin-top:8px;background:rgba(255,255,255,0.08);padding:8px;border-radius:12px;overflow:hidden;font-size:13px}
.ticker .slide{display:inline-block;white-space:nowrap;animation:marq 18s linear infinite}
@keyframes marq{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

/* sidebar & overlay */
.sidebar-toggle{position:fixed;right:12px;top:50%;transform:translateY(-50%);z-index:150}
.fab{width:48px;height:48px;border-radius:12px;border:none;background:var(--primary);color:#fff;font-size:20px;box-shadow:0 8px 20px rgba(46,125,50,0.22);cursor:pointer}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:130;opacity:0;pointer-events:none;transition:opacity .28s ease}
.overlay.show{opacity:1;pointer-events:auto}

/* sidebar */
.sidebar{position:fixed;top:0;right:0;height:100%;width:360px;max-width:92%;background:var(--card);box-shadow:-12px 0 32px rgba(0,0,0,0.12);transform:translateX(110%);transition:transform .35s ease;z-index:160;border-inline-start:1px solid var(--border);display:flex;flex-direction:column}
.sidebar.open{transform:translateX(0)}
.sidebar .head{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.sidebar .body{padding:14px;overflow:auto;flex:1}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--muted);margin:4px;border:1px solid var(--border);font-size:13px}
.list{list-style:none;padding:0;margin:10px 0}
.list li{padding:10px;border:1px solid var(--border);border-radius:10px;margin-bottom:8px;background:var(--card);font-size:14px}

/* layout */
.container{max-width:1180px;margin:16px auto;padding:0 14px}
.grid{display:grid;gap:14px}
@media(min-width:980px){.grid.cols-3{grid-template-columns:1fr 420px 320px}.grid.cols-2{grid-template-columns:1fr 420px}}
.block{background:var(--card);padding:14px;border-radius:14px;border:1px solid var(--border);box-shadow:0 6px 20px rgba(0,0,0,0.04);overflow:hidden}
.hero{position:relative;overflow:hidden;border-radius:14px;min-height:220px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02));display:flex;align-items:center}
.hero .hero-left{padding:18px}
.hero h2{margin:0;font-size:22px}
.hero p{margin:8px 0;color:#2b4b2b}

/* carousel */
.carousel{position:relative;overflow:hidden;border-radius:12px}
.slides{display:flex;transition:transform .45s ease}
.slide{flex:0 0 100%;display:block}
.car-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.45);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
.car-prev{right:10px}
.car-next{left:10px}

/* cards */
.card-list{display:grid;gap:12px}
@media(min-width:720px){.card-list.cols-2{grid-template-columns:1fr 1fr}}
.article,.product{padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card);position:relative;overflow:hidden;transition:transform .18s,box-shadow .18s}
.article:hover,.product:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(46,125,50,0.08)}
.star{position:absolute;left:10px;top:10px;font-size:20px;color:#bbb;cursor:pointer;transition:transform .25s}
.star.active{color:gold;transform:scale(1.15)}
.badge{position:absolute;right:10px;top:10px;background:var(--accent);color:#fff;padding:6px 10px;border-radius:999px;font-weight:700}

/* weather visuals */
.weather-result{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;border:1px dashed var(--border);background:linear-gradient(180deg,var(--muted),#fff)}
.weather-canvas{width:96px;height:72px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700}

/* small UI */
.controls{display:flex;gap:8px;flex-wrap:wrap}
.input{padding:10px;border-radius:12px;border:1px solid var(--border);min-width:180px}
.btn-solid{background:var(--primary);color:#fff;border:none;padding:10px;border-radius:12px;cursor:pointer}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:rgba(33,33,33,0.9);color:#fff;padding:10px 14px;border-radius:10px;z-index:200;opacity:0;pointer-events:none;transition:all .25s}
.toast.show{opacity:1;pointer-events:auto}

/* map */
#map{height:220px;border-radius:12px;border:1px solid var(--border);overflow:hidden}
#miniMap{height:160px;border-radius:10px;border:1px solid var(--border);overflow:hidden}

/* faq */
.accordion{border-radius:8px;overflow:hidden}
.ac-item{border-bottom:1px solid var(--border)}
.ac-item button{width:100%;text-align:right;padding:12px;border:0;background:transparent;cursor:pointer;font-weight:700}

/* footer and nav */
.bottom-nav{position:sticky;bottom:0;background:var(--card);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:10px;border-radius:8px;margin-top:12px}
.nav-item{display:flex;flex-direction:column;align-items:center;font-size:12px}

/* helpers */
.hidden{display:none}
.fade-in{opacity:0;transform:translateY(12px);transition:all .6s ease}
.fade-in.show{opacity:1;transform:none}
.sound-btn{background:transparent;border:0;color:var(--primary);cursor:pointer}

/* responsive */
@media(max-width:979px){
  .grid.cols-3{grid-template-columns:1fr}
  .grid.cols-2{grid-template-columns:1fr}
  .sidebar{width:92%}
}
</style>
</head>
<body>

<header>
  <div class="header-row">
    <div class="brand">
      <div style="font-size:22px">🌱</div>
      <div>
        <h1>مای‌ده</h1>
        <div style="font-size:12px;color:rgba(255,255,255,0.92)">بازار و هواشناسی روستایی — اهواز</div>
      </div>
    </div>

    <div class="actions">
      <select id="themeSelect" class="select" title="تم">
        <option value="theme-green">سبز</option>
        <option value="theme-brown">قهوه‌ای</option>
        <option value="theme-dark">تیره</option>
        <option value="">روشن</option>
      </select>
      <button id="clockBtn" class="icon-btn" title="ساعت اهواز">⏰ <span id="clockHeader" style="margin-inline-start:8px;font-weight:700">--:--:--</span></button>
    </div>
  </div>

  <div style="max-width:1180px;margin:12px auto;padding:0 14px">
    <div class="ticker"><div class="slide">🌾 خوش آمدید به مای‌ده — خرید مستقیم از مزرعه | اخبار، آموزش، هواشناسی و تقویم کشاورزی</div></div>
  </div>
</header>

<!-- sidebar toggle and overlay -->
<div class="sidebar-toggle">
  <button id="openSidebar" class="fab" title="پنل">📑</button>
</div>
<div id="overlay" class="overlay" aria-hidden="true"></div>

<!-- sidebar -->
<aside id="sidebar" class="sidebar" aria-hidden="true">
  <div class="head">
    <strong>پنل مای‌ده</strong>
    <div style="display:flex;gap:8px;align-items:center">
      <span class="pill" id="clockAhvaz">--:--:--</span>
      <button id="closeSidebar" class="icon-btn" aria-label="بستن">✕</button>
    </div>
  </div>

  <div class="body">
    <h3>⭐ علاقه‌مندی‌ها</h3>
    <ul id="favList" class="list"><li>هنوز چیزی ستاره‌دار نشده</li></ul>

    <h3>📢 اطلاعیه‌ها</h3>
    <ul id="newsList" class="list"></ul>

    <h3>⚠️ هشدارها</h3>
    <ul id="alertList" class="list"></ul>

    <h3>📊 آمار</h3>
    <div style="display:flex;flex-direction:column;gap:8px">
      <div class="pill" id="pageViews">بازدید کل: —</div>
      <canvas id="visitsChart" style="width:100%;height:120px"></canvas>
    </div>

    <h3 style="margin-top:12px">🗺️ نقشه محلی</h3>
    <div id="map"></div>
  </div>
</aside>

<!-- main -->
<main class="container" style="padding-bottom:80px">
  <div class="grid cols-3">
    <!-- main column -->
    <div>
      <!-- hero -->
      <section class="block hero fade-in" id="hero" style="margin-bottom:12px">
        <div class="hero-left">
          <h2>مای‌ده — از مزرعه تا سفره</h2>
          <p>فروش مستقیم محصولات محلی، آموزش‌های کشاورزی، هواشناسی و ابزارهایی که کار کشاورز را آسان می‌کند.</p>

          <div style="margin-top:10px;display:flex;gap:8px">
            <input id="searchInput" type="text" class="input" placeholder="جستجو در محصولات و مقالات…" />
            <button id="searchBtn" class="btn-solid">جستجو</button>
            <button id="clearSearch" class="icon-btn" style="background:#ffffff22;color:#fff;border-radius:10px">پاک‌سازی</button>
          </div>
        </div>

        <div style="flex:1;padding:14px">
          <div class="carousel" id="heroCarousel">
            <div class="slides" aria-hidden="false">
              <div class="slide"><img loading="lazy" src="https://source.unsplash.com/900x420/?farm,field" alt="مزرعه" style="width:100%;height:240px;object-fit:cover;border-radius:8px"></div>
              <div class="slide"><img loading="lazy" src="https://source.unsplash.com/900x420/?vegetables" alt="محصولات" style="width:100%;height:240px;object-fit:cover;border-radius:8px"></div>
              <div class="slide"><img loading="lazy" src="https://source.unsplash.com/900x420/?market" alt="بازار محلی" style="width:100%;height:240px;object-fit:cover;border-radius:8px"></div>
            </div>
            <button class="car-btn car-prev" onclick="heroPrev()">‹</button>
            <button class="car-btn car-next" onclick="heroNext()">›</button>
          </div>
        </div>
      </section>

      <!-- articles -->
      <section class="block fade-in" id="articlesSection">
        <h2>📚 مقالات آموزشی</h2>
        <div class="card-list cols-2" id="articleGrid"></div>
      </section>

      <!-- faq -->
      <section class="block fade-in" style="margin-top:12px">
        <h2>❓ سوالات متداول</h2>
        <div class="accordion" id="faq">
          <div class="ac-item">
            <button onclick="toggleAC(this)">بهترین زمان کاشت خیار در اهواز چیست؟</button>
            <div class="ac-body" style="padding:12px;display:none">اوایل تابستان (اوایل خرداد/تیر)؛ برداشت معمولاً حدود 35-45 روز بعد.</div>
          </div>
          <div class="ac-item">
            <button onclick="toggleAC(this)">روش صحیح آبیاری برای گوجه چیست؟</button>
            <div class="ac-body" style="padding:12px;display:none">آبیاری منظم و جلوگیری از خیس شدن مداوم برگ‌ها؛ آبیاری ریشه‌ای توصیه می‌شود.</div>
          </div>
        </div>
      </section>

      <!-- chat -->
      <section class="block fade-in" style="margin-top:12px">
        <h2>💬 مشاوره سریع</h2>
        <div id="chatBox" style="border:1px solid var(--border);border-radius:10px;padding:8px;min-height:110px;background:var(--muted);overflow:auto"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="chatInput" type="text" class="input" placeholder="سوال‌تان را بنویسید…" />
          <button id="sendChat" class="btn-solid">ارسال</button>
        </div>
      </section>
    </div>

    <!-- middle column -->
    <div>
      <section class="block fade-in">
        <h2>🌤️ وضعیت هوا</h2>
        <div class="controls" style="margin-bottom:10px">
          <input id="cityName" type="text" class="input" placeholder="نام شهر (مثلاً Ahvaz یا اهواز)" />
          <button id="getWeatherBtn" class="btn-solid">جستجوی هوا</button>
          <button id="btnMyLoc" class="icon-btn">📍 موقعیت من</button>
        </div>
        <div id="weatherResult" class="weather-result">
          <div class="weather-canvas" id="weatherCanvas">—</div>
          <div id="weatherInfo">شهر را وارد کنید یا موقعیت خود را ارسال کنید.</div>
        </div>
      </section>

      <section class="block fade-in" style="margin-top:12px">
        <h2>🛒 محصولات محلی</h2>
        <div id="productGrid" class="card-list cols-2"></div>
      </section>

      <section class="block fade-in" style="margin-top:12px">
        <h2>آمار سریع</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <div class="pill" id="todayDate">—</div>
          <div class="pill" id="seasonTip">—</div>
          <div class="pill" id="pageViewsMini">بازدید: —</div>
          <button id="clearStorage" class="icon-btn" title="ریست آمار">🗑</button>
        </div>
      </section>
    </div>

    <!-- right column -->
    <div>
      <section class="block fade-in">
        <h2>محبوب‌ترین‌ها</h2>
        <div id="popularList" style="display:flex;flex-direction:column;gap:8px"></div>
      </section>

      <section class="block fade-in" style="margin-top:12px">
        <h2>تماس سریع</h2>
        <div>واتساپ: <a href="https://wa.me/989332356547">09332356547</a></div>
        <div style="margin-top:8px">تلفن: 09332356547</div>
      </section>

      <section class="block fade-in" style="margin-top:12px">
        <h2>نقشه فروشندگان</h2>
        <div style="font-size:13px;color:#555;margin-bottom:8px">نزدیک‌ترین فروشندگان (نمونه)</div>
        <div id="miniMap"></div>
      </section>
    </div>
  </div>

  <div class="bottom-nav" style="max-width:1180px;margin:12px auto">
    <a href="#home" class="nav-item">🏠<span>خانه</span></a>
    <a href="#products" class="nav-item">🛒<span>محصولات</span></a>
    <a href="#articles" class="nav-item">📚<span>مقالات</span></a>
    <a href="#contact" class="nav-item">☎️<span>تماس</span></a>
  </div>
</main>

<div id="toast" class="toast">متن نمونه</div>

<footer style="text-align:center;padding:18px 12px;color:#666">© مای‌ده — ساخته شده با ❤️ برای روستا</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =================== پیکربندی =================== */
const WEATHER_KEY = 'dc9c93f51cdd375d459483c2a9f86d88'; // <-- کلید شما
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

/* داده‌های نمونه */
const ARTICLES = [
  {id:'art-cucumber', title:'کاشت خیار چنبر در اهواز', desc:'خیار چنبر مقاوم به گرما؛ حدود ۴۰ روز بعد برداشت.', tags:['خیار','تابستان'], fresh:true},
  {id:'art-tomato', title:'گوجه‌فرنگی - روش جوی و پشته', desc:'نکات کوددهی و آبیاری غرقابی برای گوجه', tags:['گوجه','بهار'], fresh:false},
  {id:'art-onion', title:'پیاز در اقلیم اهواز', desc:'مراحل کاشت و نگهداری پیاز', tags:['پیاز'], fresh:false},
  {id:'art-melon', title:'طالبی محلی و تکنیک برداشت', desc:'نکات افزایش شیرینی طالبی', tags:['طالبی'], fresh:true}
];
const PRODUCTS = [
  {id:'prd-cucumber', title:'خیار تازه اهواز', price:'هرکیلو ۵۵۰۰ تومان', img:'https://source.unsplash.com/600x400/?cucumber', popular:true, fresh:true},
  {id:'prd-tomato', title:'گوجه محلی رسیده', price:'هرکیلو ۶۲۰۰ تومان', img:'https://source.unsplash.com/600x400/?tomato', popular:false, fresh:false},
  {id:'prd-melon', title:'طالبی محلی', price:'هر عدد ۱۸۰۰۰ تومان', img:'https://source.unsplash.com/600x400/?melon', popular:true, fresh:true}
];

/* LocalStorage keys */
const LS = {
  pageViewsKey:'mydeh_pageviews_total',
  visitsSeriesKey:'mydeh_visits_series',
  favsKey:'mydeh_favs',
  itemViewsKey:'mydeh_item_views'
};

/* helper local storage */
function readLS(k,def){ try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : def }catch(e){ return def } }
function writeLS(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

/* ===== ساعت و تاریخ شمسی ===== */
function updateClockHeader(){
  const time = new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit',second:'2-digit',timeZone:'Asia/Tehran'});
  $('#clockHeader').innerText = time;
  $('#clockAhvaz').innerText = time;
}
function updatePersianDate(){
  const pers = new Date().toLocaleDateString('fa-IR-u-ca-persian');
  $('#todayDate').innerText = pers;
  const sh = pers.split('/');
  const month = parseInt(sh[1]||'1',10);
  let tip = 'فصل نامشخص';
  if([1,12,11].includes(month)) tip = 'آماده‌سازی زمین';
  else if([2,3,4].includes(month)) tip = 'کاشت و مراقبت';
  else if([5,6].includes(month)) tip = 'آبیاری منظم و حفاظت';
  else if([7,8].includes(month)) tip = 'برداشت محصولات تابستانی';
  $('#seasonTip').innerText = tip;
}
setInterval(updateClockHeader,1000);
updateClockHeader(); updatePersianDate();

/* ===== Toast ===== */
function showToast(text,ms=2000){
  const t = $('#toast'); t.innerText = text; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), ms);
}

/* ===== آمار بازدید ===== */
function incPageView(){
  let total = parseInt(localStorage.getItem(LS.pageViewsKey) || '0',10);
  total++; localStorage.setItem(LS.pageViewsKey, String(total));
  $('#pageViews').innerText = 'بازدید کل: ' + total;
  $('#pageViewsMini').innerText = 'بازدید: ' + total;
  let series = readLS(LS.visitsSeriesKey, Array(7).fill(0));
  series[series.length-1] = (series[series.length-1]||0) + 1;
  writeLS(LS.visitsSeriesKey, series);
  updateVisitsChart();
}
function incItemView(id){
  let obj = readLS(LS.itemViewsKey, {});
  obj[id] = (obj[id]||0)+1;
  writeLS(LS.itemViewsKey, obj);
}

/* ===== علاقه‌مندی‌ها ===== */
function getFavs(){ return readLS(LS.favsKey, []) }
function toggleFav(id){
  let favs = getFavs();
  if(favs.includes(id)){ favs = favs.filter(x=>x!==id); showToast('از علاقه‌مندی‌ها حذف شد') }
  else { favs.push(id); showToast('به علاقه‌مندی‌ها اضافه شد') }
  writeLS(LS.favsKey, favs); renderFavUI(); renderPopular();
}

/* ===== رندر مقالات و محصولات ===== */
function renderArticles(){
  const grid = $('#articleGrid'); grid.innerHTML='';
  const itemViews = readLS(LS.itemViewsKey, {});
  ARTICLES.forEach(a=>{
    const el = document.createElement('div'); el.className='article fade-in'; el.dataset.id=a.id;
    el.innerHTML = `
      <div class="badge">${a.fresh? 'تازه':'مقاله'}</div>
      <div class="star" title="افزودن به علاقه‌مندی">☆</div>
      <h3 style="margin:8px 0">${a.title}</h3>
      <p style="color:#456">${a.desc}</p>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <small>${(itemViews[a.id]||0)} بازدید</small>
        <div style="display:flex;gap:8px">
          <button class="btn" data-id="${a.id}">بیشتر</button>
        </div>
      </div>
    `;
    const star = el.querySelector('.star');
    star.onclick = (e)=>{ e.stopPropagation(); toggleFav(a.id); star.classList.toggle('active'); animateStar(star); }
    el.querySelector('button').onclick = ()=>{ incItemView(a.id); showArticleModal(a) }
    grid.appendChild(el);
  });
}
function renderProducts(){
  const grid = $('#productGrid'); grid.innerHTML='';
  const itemViews = readLS(LS.itemViewsKey, {});
  PRODUCTS.forEach(p=>{
    const el = document.createElement('div'); el.className='product fade-in'; el.dataset.id=p.id;
    el.innerHTML = `
      <div class="badge" style="background:${p.fresh? 'var(--accent)':'var(--primary)'}">${p.fresh? 'تازه':'محصول'}</div>
      <div style="display:flex;gap:12px;align-items:center">
        <img src="${p.img}" alt="${p.title}" style="width:96px;height:72px;object-fit:cover;border-radius:8px" loading="lazy">
        <div style="flex:1">
          <h4 style="margin:0">${p.title}</h4>
          <div style="color:#666;font-size:13px">${p.price}</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:12px;color:#444">${itemViews[p.id]||0} بازدید</div>
          <button class="btn" data-id="${p.id}">مشاهده</button>
        </div>
      </div>
    `;
    el.querySelector('button').onclick = ()=>{ incItemView(p.id); showProductModal(p) }
    grid.appendChild(el);
  });
}

/* ===== علاقه‌مندی UI ===== */
function renderFavUI(){
  const ul = $('#favList'); ul.innerHTML='';
  const favs = getFavs();
  if(!favs.length){ ul.innerHTML='<li>هنوز چیزی ستاره‌دار نشده</li>'; return; }
  favs.forEach(id=>{
    const art = ARTICLES.find(x=>x.id===id);
    const pr = PRODUCTS.find(x=>x.id===id);
    const title = art ? art.title : (pr ? pr.title : id);
    const li = document.createElement('li'); li.textContent = title; ul.appendChild(li);
  });
}

/* ===== محبوب‌ها ===== */
function renderPopular(){
  const pop = $('#popularList'); pop.innerHTML='';
  const itemViews = readLS(LS.itemViewsKey, {});
  const favs = getFavs();
  const combined = PRODUCTS.map(p=>({
    id:p.id, title:p.title, score:(p.popular?3:0)+(favs.includes(p.id)?2:0)+(itemViews[p.id]||0)
  })).sort((a,b)=>b.score-a.score);
  combined.slice(0,4).forEach(c=>{
    const d = document.createElement('div'); d.className='product'; d.style.padding='8px';
    d.innerHTML = `<strong>${c.title}</strong><div style="font-size:12px;color:#666">${c.score} امتیاز</div>`;
    pop.appendChild(d);
  });
}

/* ===== modals ساده (نمایش) ===== */
function showArticleModal(a){ showToast('باز کردن مقاله: ' + a.title,1200); incItemView(a.id); }
function showProductModal(p){ showToast('نمایش محصول: ' + p.title,1200); incItemView(p.id); }

/* ===== hero carousel ===== */
let heroIdx=0;
function heroNext(){ const s=$('#heroCarousel .slides'); heroIdx=(heroIdx+1)%s.children.length; s.style.transform=`translateX(-${heroIdx*100}%)` }
function heroPrev(){ const s=$('#heroCarousel .slides'); heroIdx=(heroIdx-1 + s.children.length)%s.children.length; s.style.transform=`translateX(-${heroIdx*100}%)` }
setInterval(()=>{ heroNext() },6000);

/* ===== search ===== */
$('#searchBtn').onclick = ()=>doSearch();
$('#searchInput').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch() });
$('#clearSearch').onclick = ()=>{ $('#searchInput').value=''; renderArticles(); renderProducts(); }
function doSearch(){
  const q = $('#searchInput').value.trim().toLowerCase();
  if(!q){ renderArticles(); renderProducts(); return; }
  const artGrid = $('#articleGrid'); artGrid.innerHTML='';
  ARTICLES.filter(a=> (a.title+a.desc+(a.tags||[]).join(' ')).toLowerCase().includes(q) ).forEach(a=> artGrid.appendChild(createArticleCard(a)));
  const prGrid = $('#productGrid'); prGrid.innerHTML='';
  PRODUCTS.filter(p=> (p.title + p.price).toLowerCase().includes(q)).forEach(p=> prGrid.appendChild(createProductCard(p)));
}
function createArticleCard(a){
  const el = document.createElement('div'); el.className='article fade-in'; el.dataset.id=a.id;
  el.innerHTML = `<div class="badge">${a.fresh? 'تازه':'مقاله'}</div><div class="star" title="افزودن به علاقه‌مندی">☆</div><h3 style="margin:8px 0">${a.title}</h3><p style="color:#456">${a.desc}</p>`;
  el.querySelector('.star').onclick = (e)=>{ e.stopPropagation(); toggleFav(a.id); el.querySelector('.star').classList.toggle('active'); animateStar(el.querySelector('.star')) }
  return el;
}
function createProductCard(p){
  const el = document.createElement('div'); el.className='product fade-in'; el.dataset.id=p.id;
  el.innerHTML = `<div class="badge" style="background:${p.fresh? 'var(--accent)':'var(--primary)'}">${p.fresh? 'تازه':'محصول'}</div>
  <div style="display:flex;gap:12px;align-items:center"><img src="${p.img}" alt="${p.title}" style="width:96px;height:72px;object-fit:cover;border-radius:8px" loading="lazy">
  <div><h4 style="margin:0">${p.title}</h4><div style="color:#666">${p.price}</div></div></div>`;
  return el;
}

/* ===== Weather (OpenWeatherMap) ===== */
async function showWeatherData(data){
  if(!data || data.cod!==200){ $('#weatherCanvas').innerText='—'; $('#weatherInfo').innerText='شهر یافت نشد یا خطا'; return; }
  const name = data.name;
  const t = Math.round(data.main.temp);
  const desc = data.weather[0].description;
  const hum = data.main.humidity;
  $('#weatherCanvas').innerText = t + '°';
  $('#weatherInfo').innerHTML = `<strong>${name}</strong><div style="margin-top:8px">${desc} — رطوبت: ${hum}%</div>`;
  const w = data.weather[0].main.toLowerCase();
  if(w.includes('rain')||w.includes('shower')) document.body.classList.add('raining'); else document.body.classList.remove('raining');
}
async function getWeatherByCity(city){
  try{
    $('#weatherCanvas').innerText='...';
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${WEATHER_KEY}&units=metric&lang=fa`);
    const data = await res.json();
    await showWeatherData(data);
  }catch(e){ showToast('خطا در دریافت اطلاعات هواشناسی') }
}
async function getWeatherByCoords(lat,lon){
  try{
    $('#weatherCanvas').innerText='...';
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_KEY}&units=metric&lang=fa`);
    const data = await res.json();
    await showWeatherData(data);
  }catch(e){ showToast('خطا در دریافت اطلاعات هواشناسی') }
}
$('#getWeatherBtn').onclick = ()=>{ const c = $('#cityName').value.trim() || 'Ahvaz'; getWeatherByCity(c) }
$('#btnMyLoc').onclick = ()=>{ navigator.geolocation.getCurrentPosition(p=> getWeatherByCoords(p.coords.latitude,p.coords.longitude), ()=> showToast('موقعیت یافت نشد')) }

/* ===== Maps (Leaflet) ===== */
function initMaps(){
  const map = L.map('map',{attributionControl:false}).setView([31.3183,48.6706],11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  const sellers = [
    {name:'فروشگاه الف', coords:[31.335,48.669]},
    {name:'مزرعه ب', coords:[31.28,48.64]},
    {name:'بازار محلی', coords:[31.32,48.68]}
  ];
  sellers.forEach(s=>L.marker(s.coords).addTo(map).bindPopup(s.name));
  const mini = L.map('miniMap',{attributionControl:false}).setView([31.3183,48.6706],11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(mini);
  sellers.slice(0,2).forEach(s=>L.circle(s.coords,{radius:500,color:'#2e7d32',fill:true,fillOpacity:0.12}).addTo(mini));
}
initMaps();

/* ===== Visits chart (Chart.js) ===== */
let visitsChart=null;
function updateVisitsChart(){
  const ctx = document.getElementById('visitsChart').getContext('2d');
  let series = readLS(LS.visitsSeriesKey, Array(7).fill(0));
  while(series.length<7) series.unshift(0);
  const labels = ['۶ روز','۵ روز','۴ روز','۳ روز','دیروز','امروز','امروز'];
  if(visitsChart){ visitsChart.data.datasets[0].data = series; visitsChart.update(); return; }
  visitsChart = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{label:'بازدید', data:series, borderRadius:6, backgroundColor:'rgba(46,125,50,0.7)'}] },
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}
updateVisitsChart();

/* ===== initial render ===== */
function initialRender(){
  renderArticles(); renderProducts(); renderFavUI(); renderPopular();
  $('#pageViews').innerText = 'بازدید کل: ' + (localStorage.getItem(LS.pageViewsKey) || '0');
  $('#pageViewsMini').innerText = 'بازدید: ' + (localStorage.getItem(LS.pageViewsKey) || '0');
  const obs = new IntersectionObserver(entries=>{ entries.forEach(en=>{ if(en.isIntersecting){ en.target.classList.add('show'); obs.unobserve(en.target) } }) }, {threshold:0.12});
  document.querySelectorAll('.fade-in').forEach(el=>obs.observe(el));
}
initialRender();
incPageView();

/* ===== sidebar open/close ===== */
$('#openSidebar').onclick = ()=>{
  $('#sidebar').classList.add('open'); $('#overlay').classList.add('show'); $('#sidebar').setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';
};
$('#closeSidebar').onclick = ()=>{ $('#sidebar').classList.remove('open'); $('#overlay').classList.remove('show'); $('#sidebar').setAttribute('aria-hidden','true'); document.body.style.overflow=''; };
$('#overlay').onclick = ()=>{ $('#closeSidebar').click() };

/* ===== star animation ===== */
function animateStar(el){
  el.animate([{transform:'scale(0.9)'},{transform:'scale(1.25)'},{transform:'scale(1)'}],{duration:420,easing:'cubic-bezier(.2,.8,.2,1)'});
}

/* ===== chat (local sim) ===== */
$('#sendChat').onclick = sendChat;
$('#chatInput').addEventListener('keydown', e=>{ if(e.key==='Enter') sendChat(); });
function sendChat(){
  const v = $('#chatInput').value.trim(); if(!v) return;
  addChatMessage('user', v); $('#chatInput').value='';
  setTimeout(()=> addChatMessage('bot', 'متشکرم! کارشناسان ما به‌زودی پاسخ می‌دهند. (پاسخ نمونه)') , 900);
}
function addChatMessage(who, text){
  const box = $('#chatBox');
  const el = document.createElement('div');
  el.style.padding='6px 10px'; el.style.margin='6px 0'; el.style.borderRadius='8px'; el.style.maxWidth='80%';
  if(who==='user'){ el.style.background='#e6ffe9'; el.style.marginLeft='auto'; el.innerText = text; }
  else { el.style.background='#fff'; el.style.color='#333'; el.innerText = text; }
  box.appendChild(el); box.scrollTop = box.scrollHeight;
}

/* ===== faq toggle ===== */
function toggleAC(btn){
  const body = btn.nextElementSibling;
  body.style.display = body.style.display==='block' ? 'none' : 'block';
}

/* ===== sound beep ===== */
function beep(freq=440,dur=0.06){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='sine'; o.frequency.value=freq; g.gain.value=0.02;
    o.connect(g); g.connect(ctx.destination); o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, dur*1000);
  }catch(e){}
}
document.addEventListener('click', e=>{
  if(e.target.classList && e.target.classList.contains('star')) beep(880,0.06);
  if(e.target.id==='searchBtn') beep(660,0.05);
});

/* ===== helpers for initial star state and favorites persistence ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const favs = getFavs();
  document.querySelectorAll('.article').forEach(a=>{
    const id = a.dataset.id;
    if(favs.includes(id)) a.querySelector('.star')?.classList.add('active');
  });
});

/* ===== clear local storage button ===== */
$('#clearStorage').onclick = ()=>{
  if(confirm('آیا مایلید داده‌های محلی پاک شود؟')){ localStorage.clear(); location.reload(); }
}

/* ===== lazy update popular ===== */
setInterval(()=>{ renderPopular() }, 60*1000);

/* ===== initial weather load ===== */
getWeatherByCity('Ahvaz');

/* ===== accessibility focus outline toggle ===== */
document.addEventListener('keydown', e=>{ if(e.key==='Tab') document.body.classList.add('user-tab') });
</script>
</body>
</html>
