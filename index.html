<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…Ø§ÛŒâ€ŒØ¯Ù‡ â€” Ø¨Ø§Ø²Ø§Ø± Ùˆ Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ø§Ù‡ÙˆØ§Ø² (Ù†Ø³Ø®Ù‡ Ø¬Ø§Ù…Ø¹)</title>

<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;800&display=swap" rel="stylesheet">
<!-- Leaflet (Ù†Ù‚Ø´Ù‡) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#f6fff6; --text:#1e2a1e; --card:#ffffff; --muted:#eef7ee;
  --primary:#2e7d32; --accent:#74c37a; --danger:#d9534f; --border:#dfe7df;
  --glass: rgba(255,255,255,0.6);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Vazirmatn',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
a{color:var(--primary);text-decoration:none}
header{position:sticky;top:0;z-index:80;background:linear-gradient(90deg,var(--primary),#1b5e20);color:#fff;padding:12px 16px;box-shadow:0 6px 18px rgba(0,0,0,0.12);}
.header-row{display:flex;align-items:center;justify-content:space-between;gap:10px}
.brand{display:flex;align-items:center;gap:10px}
.brand h1{margin:0;font-size:20px;font-weight:800}
.actions{display:flex;align-items:center;gap:8px}
.btn,select,input[type="text"]{border-radius:12px;padding:8px 12px;border:0;outline:none}
.select{background:rgba(255,255,255,0.12);color:#fff;border:1px solid rgba(255,255,255,0.08)}
.icon-btn{background:rgba(255,255,255,0.12);color:#fff;border:none;padding:8px;border-radius:10px;cursor:pointer}
.ticker{margin-top:8px;background:rgba(255,255,255,0.08);padding:8px;border-radius:12px;overflow:hidden;font-size:13px}
.ticker .slide{display:inline-block;white-space:nowrap;animation:marq 18s linear infinite}
@keyframes marq{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

/* sidebar */
.sidebar-toggle{position:fixed;right:12px;top:50%;transform:translateY(-50%);z-index:90}
.fab{width:48px;height:48px;border-radius:12px;border:none;background:var(--primary);color:#fff;font-size:20px;box-shadow:0 8px 20px rgba(46,125,50,0.2);cursor:pointer}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:70;opacity:0;pointer-events:none;transition:all .25s}
.overlay.show{opacity:1;pointer-events:auto}

/* actual sidebar */
.sidebar{position:fixed;top:0;right:0;height:100%;width:340px;max-width:92%;background:var(--card);box-shadow:-12px 0 32px rgba(0,0,0,0.12);transform:translateX(110%);transition:transform .35s ease;z-index:80;border-inline-start:1px solid var(--border);display:flex;flex-direction:column}
.sidebar.open{transform:translateX(0)}
.sidebar .head{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.sidebar .body{padding:14px;overflow:auto;flex:1}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--muted);margin:4px;border:1px solid var(--border);font-size:13px}
.list{list-style:none;padding:0;margin:10px 0}
.list li{padding:10px;border:1px solid var(--border);border-radius:10px;margin-bottom:8px;background:var(--card)}

/* layout */
.container{max-width:1150px;margin:16px auto;padding:0 14px}
.grid{display:grid;gap:14px}
@media(min-width:900px){.grid.cols-3{grid-template-columns:1fr 360px 320px}.grid.cols-2{grid-template-columns:1fr 420px}}
.block{background:var(--card);padding:14px;border-radius:14px;border:1px solid var(--border);box-shadow:0 6px 20px rgba(0,0,0,0.04);overflow:hidden}
.hero{position:relative;overflow:hidden;border-radius:14px;min-height:220px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02));display:flex;align-items:center}
.hero .hero-left{padding:18px}
.hero h2{margin:0;font-size:22px}
.hero p{margin:8px 0;color:#2b4b2b}

/* carousel */
.carousel{position:relative;overflow:hidden;border-radius:12px}
.slides{display:flex;transition:transform .45s ease}
.slide{flex:0 0 100%;display:block}
.car-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.45);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
.car-prev{right:10px}
.car-next{left:10px}

/* articles/products */
.card-list{display:grid;gap:12px}
@media(min-width:720px){.card-list.cols-2{grid-template-columns:1fr 1fr}}
.article,.product{padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card);position:relative;overflow:hidden;transition:transform .18s,box-shadow .18s}
.article:hover,.product:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(46,125,50,0.08)}
.star{position:absolute;left:10px;top:10px;font-size:20px;color:#bbb;cursor:pointer;transition:transform .25s}
.star.active{color:gold;transform:scale(1.15)}
.badge{position:absolute;right:10px;top:10px;background:var(--accent);color:#fff;padding:6px 10px;border-radius:999px;font-weight:700}

/* weather visuals */
.weather-result{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;border:1px dashed var(--border);background:linear-gradient(180deg,var(--muted),#fff)}
.weather-canvas{width:96px;height:72px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700}

/* small UI */
.controls{display:flex;gap:8px;flex-wrap:wrap}
.input{padding:10px;border-radius:12px;border:1px solid var(--border);min-width:180px}
.btn-solid{background:var(--primary);color:#fff;border:none;padding:10px;border-radius:12px;cursor:pointer}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:rgba(33,33,33,0.9);color:#fff;padding:10px 14px;border-radius:10px;z-index:120;opacity:0;pointer-events:none;transition:all .25s}
.toast.show{opacity:1;pointer-events:auto}

/* map */
#map{height:220px;border-radius:12px;border:1px solid var(--border);overflow:hidden}

/* faq */
.accordion{border-radius:8px;overflow:hidden}
.ac-item{border-bottom:1px solid var(--border)}
.ac-item button{width:100%;text-align:right;padding:12px;border:0;background:transparent;cursor:pointer;font-weight:700}

/* footer and nav */
.bottom-nav{position:sticky;bottom:0;background:var(--card);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:10px;border-radius:8px;margin-top:12px}
.nav-item{display:flex;flex-direction:column;align-items:center;font-size:12px}

/* small helpers */
.hidden{display:none}
.fade-in{opacity:0;transform:translateY(12px);transition:all .6s ease}
.fade-in.show{opacity:1;transform:none}
.sound-btn{background:transparent;border:0;color:var(--primary);cursor:pointer}

/* responsive tweaks */
@media(max-width:899px){
  .grid.cols-3{grid-template-columns:1fr}
  .grid.cols-2{grid-template-columns:1fr}
  .sidebar{width:92%}
}
</style>
</head>
<body class="theme-green">

<header>
  <div class="header-row container">
    <div class="brand">
      <div style="font-size:22px">ğŸŒ±</div>
      <div>
        <h1>Ù…Ø§ÛŒâ€ŒØ¯Ù‡</h1>
        <div style="font-size:12px;color:rgba(255,255,255,0.9)">Ø¨Ø§Ø²Ø§Ø± Ùˆ Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ø±ÙˆØ³ØªØ§ÛŒÛŒ â€” Ø§Ù‡ÙˆØ§Ø²</div>
      </div>
    </div>

    <div class="actions">
      <select id="themeSelect" class="select" title="ØªÙ…">
        <option value="theme-green">Ø³Ø¨Ø²</option>
        <option value="theme-brown">Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ</option>
        <option value="theme-dark">ØªÛŒØ±Ù‡</option>
        <option value="">Ø±ÙˆØ´Ù†</option>
      </select>
      <button id="clockBtn" class="icon-btn" title="Ø³Ø§Ø¹Øª Ø§Ù‡ÙˆØ§Ø²">â° <span id="clockHeader" style="margin-inline-start:8px;font-weight:700">--:--:--</span></button>
    </div>
  </div>

  <div class="container">
    <div class="ticker"><div class="slide">ğŸŒ¾ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ Ø¨Ù‡ Ù…Ø§ÛŒâ€ŒØ¯Ù‡ â€” Ø®Ø±ÛŒØ¯ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø² Ù…Ø²Ø±Ø¹Ù‡ | Ø§Ø®Ø¨Ø§Ø±ØŒ Ø¢Ù…ÙˆØ²Ø´ØŒ Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ùˆ ØªÙ‚ÙˆÛŒÙ… Ú©Ø´Ø§ÙˆØ±Ø²ÛŒ</div></div>
  </div>
</header>

<!-- sidebar toggle -->
<div class="sidebar-toggle">
  <button id="openSidebar" class="fab" title="Ù¾Ù†Ù„">ğŸ“‘</button>
</div>
<div id="overlay" class="overlay"></div>

<!-- sidebar -->
<aside id="sidebar" class="sidebar" aria-hidden="true">
  <div class="head">
    <strong>Ù¾Ù†Ù„ Ù…Ø§ÛŒâ€ŒØ¯Ù‡</strong>
    <div style="display:flex;gap:8px;align-items:center">
      <span class="pill" id="clockAhvaz">--:--:--</span>
      <button id="closeSidebar" class="icon-btn">âœ•</button>
    </div>
  </div>
  <div class="body">
    <h3>â­ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</h3>
    <ul id="favList" class="list"><li>Ù‡Ù†ÙˆØ² Ú†ÛŒØ²ÛŒ Ø³ØªØ§Ø±Ù‡â€ŒØ¯Ø§Ø± Ù†Ø´Ø¯Ù‡</li></ul>

    <h3>ğŸ“¢ Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡â€ŒÙ‡Ø§</h3>
    <ul id="newsList" class="list"></ul>

    <h3>âš ï¸ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</h3>
    <ul id="alertList" class="list"></ul>

    <h3>ğŸ“Š Ø¢Ù…Ø§Ø±</h3>
    <div style="display:flex;flex-direction:column;gap:8px">
      <div class="pill" id="pageViews">Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ú©Ù„: â€”</div>
      <canvas id="visitsChart" style="width:100%;height:120px"></canvas>
    </div>

    <h3 style="margin-top:12px">ğŸ—ºï¸ Ù†Ù‚Ø´Ù‡ Ù…Ø­Ù„ÛŒ</h3>
    <div id="map"></div>

    <div style="height:24px"></div>
  </div>
</aside>

<!-- main content -->
<main class="container" style="padding-bottom:60px">
  <div class="grid cols-3">
    <!-- main column -->
    <div>
      <!-- Hero -->
      <section class="block hero fade-in" id="hero" style="margin-bottom:12px">
        <div class="hero-left">
          <h2>Ù…Ø§ÛŒâ€ŒØ¯Ù‡ â€” Ø§Ø² Ù…Ø²Ø±Ø¹Ù‡ ØªØ§ Ø³ÙØ±Ù‡</h2>
          <p>ÙØ±ÙˆØ´ Ù…Ø³ØªÙ‚ÛŒÙ… Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…Ø­Ù„ÛŒØŒ Ø¢Ù…ÙˆØ²Ø´â€ŒÙ‡Ø§ÛŒ Ú©Ø´Ø§ÙˆØ±Ø²ÛŒØŒ Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ùˆ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ú©Ø§Ø± Ú©Ø´Ø§ÙˆØ±Ø² Ø±Ø§ Ø¢Ø³Ø§Ù† Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</p>
          <div style="margin-top:10px;display:flex;gap:8px">
            <input id="searchInput" type="text" class="input" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù…Ø­ØµÙˆÙ„Ø§Øª Ùˆ Ù…Ù‚Ø§Ù„Ø§Øªâ€¦" />
            <button id="searchBtn" class="btn-solid">Ø¬Ø³ØªØ¬Ùˆ</button>
            <button id="clearSearch" class="btn" style="background:#fff2">Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ</button>
          </div>
        </div>
        <div style="flex:1;padding:14px">
          <div class="carousel" id="heroCarousel">
            <div class="slides" aria-hidden="false">
              <div class="slide"><img loading="lazy" src="https://source.unsplash.com/900x420/?farm,field" alt="Ù…Ø²Ø±Ø¹Ù‡" style="width:100%;height:240px;object-fit:cover;border-radius:8px"></div>
              <div class="slide"><img loading="lazy" src="https://source.unsplash.com/900x420/?vegetables" alt="Ù…Ø­ØµÙˆÙ„Ø§Øª" style="width:100%;height:240px;object-fit:cover;border-radius:8px"></div>
              <div class="slide"><img loading="lazy" src="https://source.unsplash.com/900x420/?market" alt="Ø¨Ø§Ø²Ø§Ø± Ù…Ø­Ù„ÛŒ" style="width:100%;height:240px;object-fit:cover;border-radius:8px"></div>
            </div>
            <button class="car-btn car-prev" onclick="heroPrev()">â€¹</button>
            <button class="car-btn car-next" onclick="heroNext()">â€º</button>
          </div>
        </div>
      </section>

      <!-- Articles -->
      <section class="block fade-in">
        <h2>ğŸ“š Ù…Ù‚Ø§Ù„Ø§Øª Ø¢Ù…ÙˆØ²Ø´ÛŒ</h2>
        <div class="card-list cols-2" id="articleGrid">
          <!-- Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ø² JS Ø±Ù†Ø¯Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
      </section>

      <!-- FAQ -->
      <section class="block fade-in" style="margin-top:12px">
        <h2>â“ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„</h2>
        <div class="accordion" id="faq">
          <div class="ac-item">
            <button onclick="toggleAC(this)">Ø¨Ù‡ØªØ±ÛŒÙ† Ø²Ù…Ø§Ù† Ú©Ø§Ø´Øª Ø®ÛŒØ§Ø± Ø¯Ø± Ø§Ù‡ÙˆØ§Ø² Ú†ÛŒØ³ØªØŸ</button>
            <div class="ac-body" style="padding:12px">Ø§ÙˆØ§ÛŒÙ„ ØªØ§Ø¨Ø³ØªØ§Ù† (Ø§ÙˆØ§ÛŒÙ„ Ø®Ø±Ø¯Ø§Ø¯/ØªÛŒØ±) Ùˆ Ø¨Ø±Ø¯Ø§Ø´Øª Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø­Ø¯ÙˆØ¯ 35-45 Ø±ÙˆØ² Ø¨Ø¹Ø¯.</div>
          </div>
          <div class="ac-item">
            <button onclick="toggleAC(this)">Ú†Ù‡ Ú©ÙˆØ¯Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ú¯ÙˆØ¬Ù‡ Ù…Ù†Ø§Ø³Ø¨ Ø§Ø³ØªØŸ</button>
            <div class="ac-body" style="padding:12px">Ú©ÙˆØ¯ Ú©Ø§Ù…Ù„ NPK Ùˆ Ú©ÙˆØ¯Ù‡Ø§ÛŒ ÙØ³ÙØ§ØªÙ‡ Ø¯Ø± Ø§ÙˆØ§ÛŒÙ„ Ø±Ø´Ø¯ Ùˆ Ù¾ØªØ§Ø³ Ø¨Ø±Ø§ÛŒ Ø§ÙØ²Ø§ÛŒØ´ Ú©ÛŒÙÛŒØª Ù…ÛŒÙˆÙ‡ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
          </div>
        </div>
      </section>

      <!-- chat -->
      <section class="block fade-in" style="margin-top:12px">
        <h2>ğŸ’¬ Ù…Ø´Ø§ÙˆØ±Ù‡ Ø³Ø±ÛŒØ¹</h2>
        <div id="chatBox" style="border:1px solid var(--border);border-radius:10px;padding:8px;min-height:110px;background:var(--muted);overflow:auto"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="chatInput" type="text" class="input" placeholder="Ø³ÙˆØ§Ù„â€ŒØªØ§Ù† Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯â€¦" />
          <button id="sendChat" class="btn-solid">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
      </section>
    </div>

    <!-- middle column -->
    <div>
      <!-- Weather -->
      <section class="block fade-in">
        <h2>ğŸŒ¤ï¸ ÙˆØ¶Ø¹ÛŒØª Ù‡ÙˆØ§ (Ø§ÙˆÙ¾Ù†â€ŒÙˆÛŒØ°Ø±)</h2>
        <div class="controls" style="margin-bottom:10px">
          <input id="cityName" type="text" class="input" placeholder="Ù†Ø§Ù… Ø´Ù‡Ø± (Ù…Ø«Ø§Ù„: Ahvaz ÛŒØ§ Ø§Ù‡ÙˆØ§Ø²)" />
          <button id="getWeatherBtn" class="btn-solid">Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡ÙˆØ§</button>
          <button id="btnMyLoc" class="btn">ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†</button>
        </div>
        <div id="weatherResult" class="weather-result">
          <div class="weather-canvas" id="weatherCanvas">â€”</div>
          <div id="weatherInfo">Ø´Ù‡Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.</div>
        </div>
      </section>

      <!-- products -->
      <section class="block fade-in" style="margin-top:12px">
        <h2>ğŸ›’ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…Ø­Ù„ÛŒ</h2>
        <div id="productGrid" class="card-list cols-2">
          <!-- Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø§ JS Ø±Ù†Ø¯Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
      </section>

      <!-- small stats -->
      <section class="block fade-in" style="margin-top:12px">
        <h2>Ø¢Ù…Ø§Ø± Ø³Ø±ÛŒØ¹</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <div class="pill" id="todayDate">â€”</div>
          <div class="pill" id="seasonTip">â€”</div>
          <div class="pill" id="pageViewsMini">Ø¨Ø§Ø²Ø¯ÛŒØ¯: â€”</div>
          <button id="clearStorage" class="btn" title="Ø±ÛŒØ³Øª Ø¢Ù…Ø§Ø±">Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ù…Ø­Ù„ÛŒ</button>
        </div>
      </section>
    </div>

    <!-- right column -->
    <div>
      <section class="block fade-in">
        <h2>Ù…Ø­Ø¨ÙˆØ¨â€ŒØªØ±ÛŒÙ†â€ŒÙ‡Ø§</h2>
        <div id="popularList" style="display:flex;flex-direction:column;gap:8px"></div>
      </section>

      <section class="block fade-in" style="margin-top:12px">
        <h2>ØªÙ…Ø§Ø³ Ø³Ø±ÛŒØ¹</h2>
        <div>ÙˆØ§ØªØ³Ø§Ù¾: <a href="https://wa.me/989332356547">09332356547</a></div>
        <div style="margin-top:8px">ØªÙ„ÙÙ†: 09332356547</div>
      </section>

      <section class="block fade-in" style="margin-top:12px">
        <h2>Ù†Ù‚Ø´Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ú¯Ø§Ù†</h2>
        <div style="font-size:13px;color:#555;margin-bottom:8px">Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† ÙØ±ÙˆØ´Ù†Ø¯Ú¯Ø§Ù† Ø¨Ù‡ Ø´Ù…Ø§ (Ù†Ù…ÙˆÙ†Ù‡)</div>
        <div id="miniMap" style="height:160px;border-radius:10px;border:1px solid var(--border)"></div>
      </section>
    </div>
  </div>

  <div class="bottom-nav">
    <a href="#home" class="nav-item">ğŸ <span>Ø®Ø§Ù†Ù‡</span></a>
    <a href="#products" class="nav-item">ğŸ›’<span>Ù…Ø­ØµÙˆÙ„Ø§Øª</span></a>
    <a href="#articles" class="nav-item">ğŸ“š<span>Ù…Ù‚Ø§Ù„Ø§Øª</span></a>
    <a href="#contact" class="nav-item">â˜ï¸<span>ØªÙ…Ø§Ø³</span></a>
  </div>
</main>

<!-- toast -->
<div id="toast" class="toast">Ù…ØªÙ† Ù†Ù…ÙˆÙ†Ù‡</div>

<footer style="text-align:center;padding:18px 12px;color:#666">Â© Ù…Ø§ÛŒâ€ŒØ¯Ù‡ â€” Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ³ØªØ§</footer>

<!-- Scripts: Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ========= ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ ========= */
const WEATHER_KEY = 'dc9c93f51cdd375d459483c2a9f86d88'; // Ú©Ù„ÛŒØ¯ Ø´Ù…Ø§
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

/* ====== Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ù…Ù‚Ø§Ù„Ø§Øª Ùˆ Ù…Ø­ØµÙˆÙ„Ø§Øª (Ù‚Ø§Ø¨Ù„ ØªÙˆØ³Ø¹Ù‡) ====== */
const ARTICLES = [
  {id:'art-cucumber', title:'Ú©Ø§Ø´Øª Ø®ÛŒØ§Ø± Ú†Ù†Ø¨Ø± Ø¯Ø± Ø§Ù‡ÙˆØ§Ø²', desc:'Ø®ÛŒØ§Ø± Ú†Ù†Ø¨Ø± Ù…Ù‚Ø§ÙˆÙ… Ø¨Ù‡ Ú¯Ø±Ù…Ø§ØŒ Û´Û° Ø±ÙˆØ² Ø¨Ø¹Ø¯ Ø¨Ø±Ø¯Ø§Ø´Øª.', tags:['Ø®ÛŒØ§Ø±','ØªØ§Ø¨Ø³ØªØ§Ù†'], fresh:true},
  {id:'art-tomato', title:'Ú¯ÙˆØ¬Ù‡â€ŒÙØ±Ù†Ú¯ÛŒ - Ø±ÙˆØ´ Ø¬ÙˆÛŒ Ùˆ Ù¾Ø´ØªÙ‡', desc:'Ù†Ú©Ø§Øª Ú©ÙˆØ¯Ø¯Ù‡ÛŒ Ùˆ Ø¢Ø¨ÛŒØ§Ø±ÛŒ ØºØ±Ù‚Ø§Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ Ú¯ÙˆØ¬Ù‡', tags:['Ú¯ÙˆØ¬Ù‡','Ø¨Ù‡Ø§Ø±'], fresh:false},
  {id:'art-onion', title:'Ù¾ÛŒØ§Ø² Ø¯Ø± Ø§Ù‚Ù„ÛŒÙ… Ø§Ù‡ÙˆØ§Ø²', desc:'Ù…Ø±Ø§Ø­Ù„ Ú©Ø§Ø´Øª Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù¾ÛŒØ§Ø²', tags:['Ù¾ÛŒØ§Ø²'], fresh:false},
  {id:'art-melon', title:'Ø·Ø§Ù„Ø¨ÛŒ Ù…Ø­Ù„ÛŒ Ùˆ ØªÚ©Ù†ÛŒÚ© Ø¨Ø±Ø¯Ø§Ø´Øª', desc:'Ù†Ú©Ø§Øª Ø§ÙØ²Ø§ÛŒØ´ Ø´ÛŒØ±ÛŒÙ†ÛŒ Ø·Ø§Ù„Ø¨ÛŒ', tags:['Ø·Ø§Ù„Ø¨ÛŒ'], fresh:true}
];
const PRODUCTS = [
  {id:'prd-cucumber', title:'Ø®ÛŒØ§Ø± ØªØ§Ø²Ù‡ Ø§Ù‡ÙˆØ§Ø²', price:'Ù‡Ø±Ú©ÛŒÙ„Ùˆ ÛµÛµÛ°Û° ØªÙˆÙ…Ø§Ù†', img:'https://source.unsplash.com/600x400/?cucumber', popular:true, fresh:true},
  {id:'prd-tomato', title:'Ú¯ÙˆØ¬Ù‡ Ù…Ø­Ù„ÛŒ Ø±Ø³ÛŒØ¯Ù‡', price:'Ù‡Ø±Ú©ÛŒÙ„Ùˆ Û¶Û²Û°Û° ØªÙˆÙ…Ø§Ù†', img:'https://source.unsplash.com/600x400/?tomato', popular:false, fresh:false},
  {id:'prd-melon', title:'Ø·Ø§Ù„Ø¨ÛŒ Ù…Ø­Ù„ÛŒ', price:'Ù‡Ø± Ø¹Ø¯Ø¯ Û±Û¸Û°Û°Û° ØªÙˆÙ…Ø§Ù†', img:'https://source.unsplash.com/600x400/?melon', popular:true, fresh:true}
];

/* ====== Ù…Ø¯ÛŒØ±ÛŒØª Local Storage Ø¨Ø±Ø§ÛŒ Ø¢Ù…Ø§Ø± Ùˆ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ ====== */
const LS = {
  pageViewsKey:'mydeh_pageviews_total',
  visitsSeriesKey:'mydeh_visits_series', // Ø¢Ø±Ø§ÛŒÙ‡ Ø±ÙˆØ²Ø§Ù†Ù‡ 7 Ø±ÙˆØ²
  favsKey:'mydeh_favs',
  itemViewsKey:'mydeh_item_views' // object {id:count}
};
function readLS(k,def){try{return JSON.parse(localStorage.getItem(k))||def}catch(e){return def}}
function writeLS(k,v){localStorage.setItem(k,JSON.stringify(v))}

/* Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ø§Ø²Ø¯ÛŒØ¯ ØµÙØ­Ù‡ Ùˆ Ø³Ø±ÛŒ Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ø±ÙˆØ²Ø§Ù†Ù‡ */
function incPageView(){
  let total = parseInt(localStorage.getItem(LS.pageViewsKey) || '0',10);
  total++; localStorage.setItem(LS.pageViewsKey, String(total));
  $('#pageViews').innerText = 'Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ú©Ù„: ' + total;
  $('#pageViewsMini').innerText = 'Ø¨Ø§Ø²Ø¯ÛŒØ¯: ' + total;
  $('#pageViewsMini').dataset.count = total;
  // Ø³Ø±ÛŒ 7 Ø±ÙˆØ²Ù‡
  let series = readLS(LS.visitsSeriesKey, Array(7).fill(0));
  // Ø¢Ø®Ø±ÛŒÙ† Ø§Ù„Ù…Ø§Ù† Ø±Ø§ Ø¨Ù‡ Ø§Ù…Ø±ÙˆØ² Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (simple rotate)
  series[series.length-1] = (series[series.length-1]||0) + 1;
  writeLS(LS.visitsSeriesKey, series);
  updateVisitsChart();
}

/* Ø§ÙØ²Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± ÛŒÚ© Ø¢ÛŒØªÙ… (Ù…Ù‚Ø§Ù„Ù‡/Ù…Ø­ØµÙˆÙ„) */
function incItemView(id){
  let obj = readLS(LS.itemViewsKey, {});
  obj[id] = (obj[id]||0) + 1;
  writeLS(LS.itemViewsKey, obj);
}

/* favorites */
function getFavs(){return readLS(LS.favsKey, [])}
function toggleFav(id){
  let favs = getFavs();
  if(favs.includes(id)){ favs = favs.filter(x=>x!==id); showToast('Ø§Ø² Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯') }
  else { favs.push(id); showToast('Ø¨Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯') }
  writeLS(LS.favsKey, favs); renderFavUI(); renderPopular();
}

/* reset local data */
$('#clearStorage').onclick = ()=>{
  if(confirm('Ø¢ÛŒØ§ Ù…Ø§ÛŒÙ„ÛŒØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ (Ø¢Ù…Ø§Ø±ØŒ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ) Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')){ localStorage.clear(); location.reload(); }
}

/* ====== Ø³Ø§Ø¹Øª Ùˆ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ùˆ ÙØµÙ„ Ú©Ø´Ø§ÙˆØ±Ø²ÛŒ ====== */
function updateClockHeader(){
  const time = new Date().toLocaleTimeString('fa-IR',{hour:'2-digit',minute:'2-digit',second:'2-digit',timeZone:'Asia/Tehran'});
  $('#clockHeader').innerText = time;
  $('#clockAhvaz').innerText = time;
}
function updatePersianDate(){
  // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªÙ‚ÙˆÛŒÙ… ÙØ§Ø±Ø³ÛŒ (Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒâ€ŒØ´Ø¯Ù‡)
  let pers = new Date().toLocaleDateString('fa-IR-u-ca-persian');
  $('#todayDate').innerText = pers;
  // ÙØµÙ„ Ú©Ø´Ø§ÙˆØ±Ø²ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø§Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ø´Ø¯Ù‡ØŒ Ø§Ø² Ù…Ø§Ù‡ Ø´Ù…Ø³ÛŒ Ø±ÙÙ†Ø¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…:
  let sh = new Date().toLocaleDateString('fa-IR-u-ca-persian').split('/'); // ['Û±Û´Û°Û²','Ûµ','Û±Ûµ']
  let month = parseInt(sh[1]||'1',10);
  let tip = 'ÙØµÙ„ Ù†Ø§Ù…Ø´Ø®Øµ';
  if([1,12,11].includes(month)) tip = 'Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø²Ù…ÛŒÙ†';
  else if([2,3,4].includes(month)) tip = 'Ú©Ø§Ø´Øª Ùˆ Ù…Ø±Ø§Ù‚Ø¨Øª';
  else if([5,6].includes(month)) tip = 'Ø¢Ø¨ÛŒØ§Ø±ÛŒ Ù…Ù†Ø¸Ù… Ùˆ Ø­ÙØ§Ø¸Øª';
  else if([7,8].includes(month)) tip = 'Ø¨Ø±Ø¯Ø§Ø´Øª Ù…Ø­ØµÙˆÙ„Ø§Øª ØªØ§Ø¨Ø³ØªØ§Ù†ÛŒ';
  $('#seasonTip').innerText = tip;
}
setInterval(updateClockHeader,1000);
updateClockHeader(); updatePersianDate();

/* ====== Toast (Ù¾ÛŒØºØ§Ù… Ú©ÙˆÚ†Ú©) ====== */
function showToast(text,ms=2200){
  const t = $('#toast'); t.innerText = text; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), ms);
}

/* ====== render Ù…Ù‚Ø§Ù„Ø§Øª Ùˆ Ù…Ø­ØµÙˆÙ„Ø§Øª ====== */
function renderArticles(){
  const grid = $('#articleGrid'); grid.innerHTML='';
  const itemViews = readLS(LS.itemViewsKey,{});
  ARTICLES.forEach(a=>{
    const el = document.createElement('div'); el.className='article fade-in';
    el.dataset.id=a.id;
    el.innerHTML = `
      <div class="badge">${a.fresh? 'ØªØ§Ø²Ù‡':'Ù…Ù‚Ø§Ù„Ù‡'}</div>
      <div class="star" title="Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ">â˜†</div>
      <h3 style="margin:8px 0">${a.title}</h3>
      <p style="color:#456">${a.desc}</p>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <small>${(itemViews[a.id]||0)} Ø¨Ø§Ø²Ø¯ÛŒØ¯</small>
        <button class="btn" data-id="${a.id}">Ø¨ÛŒØ´ØªØ±</button>
      </div>
    `;
    // events
    el.querySelector('.star').onclick = (e)=>{ e.stopPropagation(); toggleFav(a.id); el.querySelector('.star').classList.toggle('active'); animateStar(el.querySelector('.star')) }
    el.querySelector('button').onclick = ()=>{ incItemView(a.id); showArticleModal(a) }
    el.onclick = ()=>{ el.classList.toggle('open') }
    grid.appendChild(el);
  });
}
function renderProducts(){
  const grid = $('#productGrid'); grid.innerHTML='';
  const itemViews = readLS(LS.itemViewsKey,{});
  PRODUCTS.forEach(p=>{
    const el = document.createElement('div'); el.className='product fade-in';
    el.dataset.id=p.id;
    el.innerHTML = `
      <div class="badge" style="background:${p.fresh? 'var(--accent)': 'var(--primary)'}">${p.fresh? 'ØªØ§Ø²Ù‡':'Ù…Ø­ØµÙˆÙ„'}</div>
      <div style="display:flex;gap:12px;align-items:center">
        <img src="${p.img}" alt="${p.title}" style="width:96px;height:72px;object-fit:cover;border-radius:8px" loading="lazy">
        <div style="flex:1">
          <h4 style="margin:0">${p.title}</h4>
          <div style="color:#666;font-size:13px">${p.price}</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:12px;color:#444">${itemViews[p.id]||0} Ø¨Ø§Ø²Ø¯ÛŒØ¯</div>
          <button class="btn" data-id="${p.id}">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button>
        </div>
      </div>
    `;
    el.querySelector('button').onclick = ()=>{ incItemView(p.id); showProductModal(p) }
    grid.appendChild(el);
  });
}

/* ====== Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ UI ====== */
function renderFavUI(){
  const ul = $('#favList'); ul.innerHTML='';
  const favs = getFavs();
  if(!favs.length){ ul.innerHTML='<li>Ù‡Ù†ÙˆØ² Ú†ÛŒØ²ÛŒ Ø³ØªØ§Ø±Ù‡â€ŒØ¯Ø§Ø± Ù†Ø´Ø¯Ù‡</li>'; return; }
  favs.forEach(id=>{
    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¹Ù†ÙˆØ§Ù† Ø§Ø² ARTICLES ÛŒØ§ PRODUCTS
    const art = ARTICLES.find(x=>x.id===id);
    const pr = PRODUCTS.find(x=>x.id===id);
    const title = art ? art.title : (pr ? pr.title : id);
    const li = document.createElement('li'); li.textContent = title; ul.appendChild(li);
  });
}

/* ====== Popular suggestions Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ùˆ favorites ====== */
function renderPopular(){
  const pop = $('#popularList'); pop.innerHTML='';
  // ØªØ±Ú©ÛŒØ¨ Ø§Ø·Ù„Ø§Ø¹Ø§Øª: Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ùˆ Ù…Ø­Ø¨ÙˆØ¨ÛŒØª Ø¯Ø³ØªÛŒ
  const itemViews = readLS(LS.itemViewsKey,{});
  // Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…Ø­Ø¨ÙˆØ¨ Ø³Ø®Øªâ€ŒÚ©Ø¯: Ù…Ø­ØµÙˆÙ„Ø§ØªÛŒ Ú©Ù‡ popular=true ÛŒØ§ Ø¯Ø± favorites Ù‡Ø³ØªÙ†Ø¯
  const favs = getFavs();
  const combined = PRODUCTS.map(p=>({
    id:p.id, title:p.title, score:(p.popular?3:0)+(favs.includes(p.id)?2:0)+(itemViews[p.id]||0)
  })).sort((a,b)=>b.score-a.score);
  combined.slice(0,4).forEach(c=>{
    const d = document.createElement('div'); d.className='product';
    d.style.padding='8px'; d.innerHTML = `<strong>${c.title}</strong><div style="font-size:12px;color:#666">${c.score} Ø§Ù…ØªÛŒØ§Ø²</div>`;
    pop.appendChild(d);
  });
}

/* ====== Article/Product modals (Ø³Ø§Ø¯Ù‡) ====== */
function showArticleModal(a){
  showToast('Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ù‚Ø§Ù„Ù‡: ' + a.title,1200);
  incItemView(a.id);
}
function showProductModal(p){
  showToast('Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„: ' + p.title,1200);
  incItemView(p.id);
}

/* ====== Hero Carousel controls ====== */
let heroIdx=0;
function heroNext(){ const s=$('#heroCarousel .slides'); heroIdx=(heroIdx+1)%s.children.length; s.style.transform=`translateX(-${heroIdx*100}%)` }
function heroPrev(){ const s=$('#heroCarousel .slides'); heroIdx=(heroIdx-1 + s.children.length)%s.children.length; s.style.transform=`translateX(-${heroIdx*100}%)` }
setInterval(()=>{ heroNext() },6000);

/* ====== Search ====== */
$('#searchBtn').onclick = ()=>doSearch();
$('#searchInput').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch() });
$('#clearSearch').onclick = ()=>{ $('#searchInput').value=''; renderArticles(); renderProducts(); }
function doSearch(){
  const q = $('#searchInput').value.trim().toLowerCase();
  if(!q){ renderArticles(); renderProducts(); return; }
  // filter articles
  const artGrid = $('#articleGrid'); artGrid.innerHTML='';
  ARTICLES.filter(a=> (a.title+a.desc+(a.tags||[]).join(' ')).toLowerCase().includes(q) ).forEach(a=>{
    artGrid.appendChild(createArticleCard(a));
  });
  // filter products
  const prGrid = $('#productGrid'); prGrid.innerHTML='';
  PRODUCTS.filter(p=> (p.title + p.price).toLowerCase().includes(q)).forEach(p=>{
    prGrid.appendChild(createProductCard(p));
  });
}
/* helper create card for search (used above) */
function createArticleCard(a){
  const el = document.createElement('div'); el.className='article fade-in'; el.dataset.id=a.id;
  el.innerHTML = `<div class="badge">${a.fresh? 'ØªØ§Ø²Ù‡':'Ù…Ù‚Ø§Ù„Ù‡'}</div><div class="star">â˜†</div><h3 style="margin:8px 0">${a.title}</h3><p style="color:#456">${a.desc}</p>`;
  el.querySelector('.star').onclick = (e)=>{ e.stopPropagation(); toggleFav(a.id); el.querySelector('.star').classList.toggle('active'); animateStar(el.querySelector('.star')) }
  return el;
}
function createProductCard(p){
  const el = document.createElement('div'); el.className='product fade-in'; el.dataset.id=p.id;
  el.innerHTML = `<div class="badge" style="background:${p.fresh? 'var(--accent)':'var(--primary)'}">${p.fresh? 'ØªØ§Ø²Ù‡':'Ù…Ø­ØµÙˆÙ„'}</div>
  <div style="display:flex;gap:12px;align-items:center"><img src="${p.img}" alt="${p.title}" style="width:96px;height:72px;object-fit:cover;border-radius:8px" loading="lazy">
  <div><h4 style="margin:0">${p.title}</h4><div style="color:#666">${p.price}</div></div></div>`;
  return el;
}

/* ====== Weather (OpenWeatherMap) ====== */
async function showWeatherData(data){
  if(!data || data.cod!==200){ $('#weatherResult').querySelector('#weatherCanvas').innerText='â€”'; $('#weatherInfo').innerText='Ø´Ù‡Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ø®Ø·Ø§'; return; }
  const name = data.name;
  const t = Math.round(data.main.temp);
  const desc = data.weather[0].description;
  const hum = data.main.humidity;
  $('#weatherCanvas').innerText = t + 'Â°';
  $('#weatherInfo').innerHTML = `<strong>${name}</strong><div style="margin-top:8px">${desc} â€” Ø±Ø·ÙˆØ¨Øª: ${hum}%</div>`;
  // Ø§ÙÚ©Øª Ø³Ø§Ø¯Ù‡ Ù‡ÙˆØ§
  const w = data.weather[0].main.toLowerCase();
  if(w.includes('rain')||w.includes('shower')) document.body.classList.add('raining'); else document.body.classList.remove('raining');
}
async function getWeatherByCity(city){
  try{
    $('#weatherCanvas').innerText='...';
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${WEATHER_KEY}&units=metric&lang=fa`);
    const data = await res.json();
    await showWeatherData(data);
  }catch(e){ showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ') }
}
async function getWeatherByCoords(lat,lon){
  try{
    $('#weatherCanvas').innerText='...';
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_KEY}&units=metric&lang=fa`);
    const data = await res.json();
    await showWeatherData(data);
  }catch(e){ showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ') }
}
$('#getWeatherBtn').onclick = ()=>{ const c = $('#cityName').value.trim() || 'Ahvaz'; getWeatherByCity(c) }
$('#btnMyLoc').onclick = ()=>{ navigator.geolocation.getCurrentPosition(p=> getWeatherByCoords(p.coords.latitude,p.coords.longitude), ()=> showToast('Ù…ÙˆÙ‚Ø¹ÛŒØª ÛŒØ§ÙØª Ù†Ø´Ø¯')) }

/* ====== Map (Leaflet) ====== */
function initMaps(){
  // main sidebar map
  const map = L.map('map',{attributionControl:false}).setView([31.3183,48.6706],11); // Ø§Ù‡ÙˆØ§Ø²
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  // Ú†Ù†Ø¯ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ù†Ù…ÙˆÙ†Ù‡
  const sellers = [
    {name:'ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø§Ù„Ù', coords:[31.335,48.669]},
    {name:'Ù…Ø²Ø±Ø¹Ù‡ Ø¨', coords:[31.28,48.64]},
    {name:'Ø¨Ø§Ø²Ø§Ø± Ù…Ø­Ù„ÛŒ', coords:[31.32,48.68]}
  ];
  sellers.forEach(s=>L.marker(s.coords).addTo(map).bindPopup(s.name));
  // mini map
  const mini = L.map('miniMap',{attributionControl:false}).setView([31.3183,48.6706],11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(mini);
  sellers.slice(0,2).forEach(s=>L.circle(s.coords,{radius:500,color:'#2e7d32',fill:true,fillOpacity:0.12}).addTo(mini));
}
initMaps();

/* ====== Visits chart ====== */
let visitsChart=null;
function updateVisitsChart(){
  const ctx = document.getElementById('visitsChart').getContext('2d');
  let series = readLS(LS.visitsSeriesKey, Array(7).fill(0));
  // ensure length 7
  while(series.length<7) series.unshift(0);
  const labels = ['Û¶ Ø±ÙˆØ²','Ûµ Ø±ÙˆØ²','Û´ Ø±ÙˆØ²','Û³ Ø±ÙˆØ²','Ø¯ÛŒØ±ÙˆØ²','Ø§Ù…Ø±ÙˆØ²','Ø§Ù…Ø±ÙˆØ²'];
  if(visitsChart){ visitsChart.data.datasets[0].data = series; visitsChart.update(); return; }
  visitsChart = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{label:'Ø¨Ø§Ø²Ø¯ÛŒØ¯', data:series, borderRadius:6, backgroundColor:'rgba(46,125,50,0.7)'}] },
    options:{responsive:true,plugins:{legend:{display:false}}}
  });
}
updateVisitsChart();

/* ====== Popular render & initial render ====== */
function initialRender(){
  renderArticles(); renderProducts(); renderFavUI(); renderPopular();
  // update pageviews
  $('#pageViews').innerText = 'Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ú©Ù„: ' + (localStorage.getItem(LS.pageViewsKey) || '0');
  $('#pageViewsMini').innerText = 'Ø¨Ø§Ø²Ø¯ÛŒØ¯: ' + (localStorage.getItem(LS.pageViewsKey) || '0');
  // attach events to article/product dynamic buttons via delegation
  // fade-in reveal
  const obs = new IntersectionObserver(entries=>{ entries.forEach(en=>{ if(en.isIntersecting){ en.target.classList.add('show'); obs.unobserve(en.target) } }) }, {threshold:0.12});
  document.querySelectorAll('.fade-in').forEach(el=>obs.observe(el));
}
initialRender();

/* ====== Increment page view on load ====== */
incPageView();

/* ====== small UI helpers ====== */
$('#openSidebar').onclick = ()=>{
  $('#sidebar').classList.add('open'); $('#overlay').classList.add('show'); $('#sidebar').setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';
};
$('#closeSidebar').onclick = ()=>{ $('#sidebar').classList.remove('open'); $('#overlay').classList.remove('show'); $('#sidebar').setAttribute('aria-hidden','true'); document.body.style.overflow=''; };
$('#overlay').onclick = ()=>{ $('#closeSidebar').click() };

/* ====== star animation ====== */
function animateStar(el){
  el.animate([{transform:'scale(0.9)'},{transform:'scale(1.25)'},{transform:'scale(1)'}],{duration:420,easing:'cubic-bezier(.2,.8,.2,1)'});
}

/* ====== simple chat (local simulation) ====== */
$('#sendChat').onclick = sendChat;
$('#chatInput').addEventListener('keydown', e=>{ if(e.key==='Enter') sendChat(); });
function sendChat(){
  const v = $('#chatInput').value.trim(); if(!v) return;
  addChatMessage('user', v); $('#chatInput').value='';
  // simulated reply
  setTimeout(()=> addChatMessage('bot', 'Ù…ØªØ´Ú©Ø±Ù…! Ú©Ø§Ø±Ø´Ù†Ø§Ø³Ø§Ù† Ù…Ø§ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯. (Ù¾Ø§Ø³Ø® Ù†Ù…ÙˆÙ†Ù‡)') , 900);
}
function addChatMessage(who, text){
  const box = $('#chatBox');
  const el = document.createElement('div');
  el.style.padding='6px 10px'; el.style.margin='6px 0'; el.style.borderRadius='8px'; el.style.maxWidth='80%';
  if(who==='user'){ el.style.background='#e6ffe9'; el.style.marginLeft='auto'; el.innerText = text; }
  else { el.style.background='#fff'; el.style.color='#333'; el.innerText = text; }
  box.appendChild(el); box.scrollTop = box.scrollHeight;
}

/* ====== FAQ toggle ====== */
function toggleAC(btn){
  const body = btn.nextElementSibling;
  body.style.display = body.style.display==='block' ? 'none' : 'block';
}

/* ====== Mini maps already init above ====== */

/* ====== play small beep on actions (WebAudio) ====== */
function beep(freq=440,dur=0.06){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='sine'; o.frequency.value=freq; g.gain.value=0.02;
    o.connect(g); g.connect(ctx.destination); o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, dur*1000);
  }catch(e){}
}
// add beep to favorites and search
document.addEventListener('click', e=>{
  if(e.target.classList && e.target.classList.contains('star')) beep(880,0.06);
  if(e.target.id==='searchBtn') beep(660,0.05);
});

/* ====== small animation for star activation from persisted favs ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  // mark stars active if in favs
  const favs = getFavs();
  document.querySelectorAll('.article').forEach(a=>{
    const id = a.dataset.id;
    if(favs.includes(id)) a.querySelector('.star')?.classList.add('active');
  });
});

/* ====== lazy: update popular each minute ====== */
setInterval(()=>{ renderPopular() }, 60*1000);

/* ====== finally, initial weather load for Ahvaz ====== */
getWeatherByCity('Ahvaz');

/* ====== small accessibility: focus outline on keyboard nav ====== */
document.addEventListener('keydown', e=>{ if(e.key==='Tab') document.body.classList.add('user-tab') });
</script>
</body>
</html>
