<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>مای‌ده - کشاورزی و هواشناسی</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
  /* ====== پایه تم (CSS Variables) ====== */
  :root{
    --bg: #f6fff6;
    --text: #232323;
    --card: #ffffff;
    --muted: #eef7ee;
    --primary: #2e7d32;
    --shadow: 0 6px 18px rgba(0,0,0,0.08);
    --border: #dfe7df;
  }
  /* تم تیره */
  .theme-dark{
    --bg: #171a17;
    --text: #f2fff2;
    --card: #222a22;
    --muted: #243024;
    --primary: #74d37a;
    --shadow: 0 8px 20px rgba(0,0,0,0.35);
    --border: #2f3a2f;
  }
  /* تم سبز کشاورزی */
  .theme-green{
    --bg: #f2fff6;
    --text: #203220;
    --card: #ffffff;
    --muted: #e6f5ea;
    --primary: #2e7d32;
    --shadow: 0 6px 18px rgba(46,125,50,0.18);
    --border: #cfe4d4;
  }
  /* تم قهوه‌ای خاک */
  .theme-brown{
    --bg: #f9f6f2;
    --text: #2e241a;
    --card: #ffffff;
    --muted: #efe7de;
    --primary: #7a5230;
    --shadow: 0 6px 18px rgba(122,82,48,0.18);
    --border: #e1d5c8;
  }

  /* ====== پایه صفحه ====== */
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:'Vazirmatn', Tahoma, sans-serif;
    line-height:1.75;
  }
  a{color:var(--primary); text-decoration:none}
  img{max-width:100%; display:block}

  /* ====== هدر ====== */
  header{
    position: sticky; top:0; z-index:10;
    background: linear-gradient(135deg, var(--primary), #1b4b1d);
    color:#fff;
    padding:12px 16px 8px;
    box-shadow: var(--shadow);
  }
  .head-row{
    display:flex; align-items:center; gap:8px; justify-content:space-between;
  }
  .brand{
    display:flex; align-items:center; gap:10px;
  }
  .brand h1{
    margin:0; font-size:20px; font-weight:800; letter-spacing:-0.3px;
  }
  .head-actions{
    display:flex; align-items:center; gap:8px;
  }
  .select, .btn{
    border:none; border-radius:12px;
    padding:8px 12px; background:#ffffff22; color:#fff;
    backdrop-filter: blur(6px);
    cursor:pointer; font-weight:600;
  }
  .select{
    appearance:none; outline:none;
  }
  .ticker{
    margin-top:8px;
    background:#ffffff22; border-radius:12px; padding:8px 12px;
    overflow:hidden; position:relative;
    font-size:14px;
  }
  .ticker .slide{
    white-space:nowrap;
    display:inline-block;
    animation: marquee 15s linear infinite;
  }
  @keyframes marquee{
    from{transform:translateX(0)}
    to{transform:translateX(-100%)}
  }

  /* ====== سایدبار کشویی ====== */
  .sidebar-toggle{
    position:fixed; top:50%; inset-inline-end:10px; transform:translateY(-50%);
    z-index:20;
  }
  .fab{
    width:48px; height:48px; border-radius:14px; border:none; cursor:pointer;
    background:var(--primary); color:#fff; font-size:20px; box-shadow:var(--shadow);
  }
  .sidebar{
    position:fixed; top:0; inset-inline-end:0; height:100%;
    width:320px; max-width:92%;
    background:var(--card); color:var(--text);
    box-shadow: -8px 0 24px rgba(0,0,0,0.12);
    transform: translateX(100%);
    transition: transform .35s ease;
    z-index:30; display:flex; flex-direction:column;
    border-inline-start:1px solid var(--border);
  }
  .sidebar.open{ transform: translateX(0) }
  .sidebar-head{
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:12px 14px; background:var(--muted); border-bottom:1px solid var(--border);
  }
  .sidebar-body{
    padding:12px; overflow:auto; flex:1;
  }
  .pill{
    display:inline-block; background:var(--muted); border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; margin:2px;
  }
  .list{margin:8px 0; padding:0; list-style:none}
  .list li{
    border:1px solid var(--border); border-radius:12px; padding:10px; margin:8px 0; background:var(--card);
  }

  /* ====== بلوک‌ها و کارت‌ها ====== */
  section{padding:14px}
  .block{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:14px;
    box-shadow: var(--shadow);
    margin:12px 0;
  }
  .block h2{margin:0 0 8px 0; font-size:18px}
  .muted{background:var(--muted)}
  .grid{
    display:grid; gap:12px;
  }
  @media(min-width:720px){
    .grid.cols-2{ grid-template-columns:1fr 1fr }
    .grid.cols-3{ grid-template-columns:repeat(3,1fr) }
  }

  /* ====== هواشناسی ====== */
  .controls{
    display:flex; gap:8px; flex-wrap:wrap; margin:10px 0;
  }
  .input, .btn-solid{
    border:1px solid var(--border);
    background:var(--card);
    color:var(--text);
    border-radius:12px; padding:10px 12px;
  }
  .btn-solid{ background:var(--primary); color:#fff; border:none; cursor:pointer }

  .weather-result{
    display:flex; align-items:center; gap:12px; padding:12px; border:1px dashed var(--border);
    border-radius:12px; background:var(--muted); margin-top:10px;
  }

  /* ====== مقالات ====== */
  .article{
    border:1px solid var(--border); border-radius:14px; padding:12px; background:var(--card); position:relative; overflow:hidden;
    transition: transform .2s ease, box-shadow .2s ease;
  }
  .article:hover{ transform:translateY(-2px); box-shadow:var(--shadow) }
  .article .star{
    position:absolute; inset-inline-start:10px; top:10px; cursor:pointer; user-select:none; font-size:20px; color:#bbb;
  }
  .article .star.active{ color:gold }
  .article .content{ display:none; margin-top:8px }
  .article.open .content{ display:block }

  /* ====== محصولات / گالری ====== */
  .product{
    border:1px solid var(--border); border-radius:16px; padding:12px; background:var(--card);
  }
  .carousel{
    position:relative; overflow:hidden; border-radius:12px; border:1px solid var(--border); background:var(--muted);
  }
  .slides{ display:flex; transition: transform .35s ease }
  .slides img{ width:100%; flex: 0 0 100% }
  .car-btn{
    position:absolute; top:50%; transform:translateY(-50%); border:none; background:#0007; color:#fff; padding:8px 10px; border-radius:10px; cursor:pointer
  }
  .car-prev{ inset-inline-start:6px }
  .car-next{ inset-inline-end:6px }

  /* ====== ناوبری پایین ====== */
  .bottom-nav{
    position:sticky; bottom:0; z-index:9;
    display:flex; justify-content:space-around; gap:8px; align-items:center;
    background:var(--card); border-top:1px solid var(--border);
    padding:8px; box-shadow: var(--shadow);
  }
  .nav-item{
    display:flex; flex-direction:column; align-items:center; font-size:12px; gap:4px; color:var(--text)
  }

  /* ====== دکمه بازگشت به بالا ====== */
  .to-top{
    position:fixed; inset-inline-end:16px; bottom:76px; z-index:8;
    width:44px; height:44px; border:none; border-radius:50%;
    background:var(--primary); color:#fff; display:none; cursor:pointer; box-shadow:var(--shadow)
  }
  .to-top.show{ display:block }

  /* ====== فوتر کوچک ====== */
  footer{
    text-align:center; font-size:12px; color:#666; padding:18px 10px
  }
</style>
</head>
<body class="theme-green">

<header id="home">
  <div class="head-row">
    <div class="brand">
      <span style="font-size:22px">🌱</span>
      <h1>مای‌ده - بازار و هواشناسی اهواز</h1>
    </div>
    <div class="head-actions">
      <select id="themeSelect" class="select" title="انتخاب تم">
        <option value="theme-green">سبز</option>
        <option value="theme-brown">قهوه‌ای</option>
        <option value="theme-dark">تیره</option>
        <option value="">روشن</option>
      </select>
      <button id="clockBtn" class="btn" title="ساعت اهواز">⏰</button>
    </div>
  </div>
  <div class="ticker" aria-live="polite">
    <div class="slide">🌾 خوش آمدید به مای‌ده | فروش مستقیم محصولات محلی | ابزارهای کشاورزی و هواشناسی حرفه‌ای | پرداخت فقط حضوری | اهواز و روستاهای اطراف </div>
  </div>
</header>

<!-- دکمه سایدبار -->
<div class="sidebar-toggle">
  <button class="fab" id="openSidebar" title="لیست/اطلاعیه/هشدار">📑</button>
</div>

<!-- سایدبار -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-head">
    <strong>پنل مای‌ده</strong>
    <div>
      <span class="pill" id="clockAhvaz">--:--</span>
      <button class="btn" id="closeSidebar">بستن</button>
    </div>
  </div>
  <div class="sidebar-body">
    <h3 style="margin:6px 0">⭐ علاقه‌مندی‌ها</h3>
    <ul class="list" id="favList"><li>هنوز چیزی ستاره‌دار نشده</li></ul>

    <h3 style="margin:14px 0 6px">📢 اطلاعیه‌ها</h3>
    <ul class="list" id="newsList"></ul>

    <h3 style="margin:14px 0 6px">⚠️ هشدارها</h3>
    <ul class="list" id="alertList"></ul>
  </div>
</aside>

<!-- جستجو + تقویم کشاورزی -->
<section class="block muted">
  <div class="grid cols-2">
    <div>
      <h2>🔎 جستجو</h2>
      <div class="controls">
        <input class="input" id="searchInput" placeholder="نام محصول یا مقاله را بنویسید…" />
        <button class="btn-solid" id="searchBtn">جستجو</button>
        <button class="btn" id="clearSearch">پاک‌سازی</button>
      </div>
      <small>نتایج جستجو، بخش «مقالات» و «محصولات» را فیلتر می‌کند.</small>
    </div>
    <div>
      <h2>📆 تقویم کشاورزی (اهواز)</h2>
      <div class="controls">
        <span class="pill" id="todayDate">—</span>
        <span class="pill" id="seasonTip">—</span>
        <span class="pill" id="pageViews">بازدید: —</span>
      </div>
    </div>
  </div>
</section>

<!-- هواشناسی -->
<section class="block" id="weather">
  <h2>🌤️ وضعیت هوا</h2>
  <div class="controls">
    <input class="input" id="cityInput" placeholder="نام شهر (فارسی یا انگلیسی)" />
    <button class="btn-solid" id="btnSearchWeather">جستجو</button>
    <button class="btn" id="btnMyLocation">📍 موقعیت من</button>
  </div>
  <div id="weatherResult" class="weather-result" style="display:none"></div>
</section>

<!-- مقالات -->
<section class="block" id="articles">
  <h2>📚 مقالات</h2>
  <div class="grid cols-2" id="articleGrid">
    <article class="article" data-id="art-cucumber">
      <div class="star" title="افزودن به علاقه‌مندی‌ها">☆</div>
      <h3>کشت خیار در اهواز</h3>
      <small class="pill">تابستان | اوایل شهریور</small>
      <div class="content">
        خیار در اوایل ماه ۶ کاشته می‌شود و حدود ۴۰ روز بعد برداشت می‌گردد. مناسب برای تابستان گرم اهواز، با آبیاری منظم و سایه‌بان سبک.
      </div>
    </article>

    <article class="article" data-id="art-tomato">
      <div class="star" title="افزودن به علاقه‌مندی‌ها">☆</div>
      <h3>گوجه‌فرنگی در اهواز</h3>
      <small class="pill">بهار | روش جوی و پشته</small>
      <div class="content">
        گوجه با روش سنتی جوی و پشته و آبیاری غرقابی کاشته می‌شود. تهویه مناسب و کنترل بیماری‌های قارچی توصیه می‌شود.
      </div>
    </article>

    <article class="article" data-id="art-onion">
      <div class="star" title="افزودن به علاقه‌مندی‌ها">☆</div>
      <h3>پیاز در اهواز</h3>
      <small class="pill">پاییز | برداشت تابستان</small>
      <div class="content">
        پیاز در پاییز کاشته و در تابستان برداشت می‌شود. مدیریت تغذیه و مبارزه با علف‌های هرز کلیدی است.
      </div>
    </article>

    <article class="article" data-id="art-melon">
      <div class="star" title="افزودن به علاقه‌مندی‌ها">☆</div>
      <h3>طالبی محلی</h3>
      <small class="pill">بهار | دمای معتدل</small>
      <div class="content">
        برای شیرینی بیشتر، آبیاری را پیش از برداشت کمی کاهش دهید و نور کافی فراهم کنید.
      </div>
    </article>
  </div>
</section>

<!-- محصولات + گالری -->
<section class="block" id="products">
  <h2>🛒 محصولات کشاورزی</h2>
  <div class="grid cols-2" id="productGrid">
    <div class="product" data-title="خیار تازه اهواز">
      <strong>خیار تازه اهواز</strong>
      <div class="carousel" data-index="0">
        <div class="slides">
          <img src="https://via.placeholder.com/800x420?text=%D8%AE%DB%8C%D8%A7%D8%B1+1" alt="خیار 1">
          <img src="https://via.placeholder.com/800x420?text=%D8%AE%DB%8C%D8%A7%D8%B1+2" alt="خیار 2">
          <img src="https://via.placeholder.com/800x420?text=%D8%AE%DB%8C%D8%A7%D8%B1+3" alt="خیار 3">
        </div>
        <button class="car-btn car-prev">‹</button>
        <button class="car-btn car-next">›</button>
      </div>
      <p>برداشت مستقیم از مزرعه. خرید حضوری.</p>
    </div>

    <div class="product" data-title="گوجه محلی رسیده">
      <strong>گوجه محلی رسیده</strong>
      <div class="carousel" data-index="0">
        <div class="slides">
          <img src="https://via.placeholder.com/800x420?text=%DA%AF%D9%88%D8%AC%D9%87+1" alt="گوجه 1">
          <img src="https://via.placeholder.com/800x420?text=%DA%AF%D9%88%D8%AC%D9%87+2" alt="گوجه 2">
        </div>
        <button class="car-btn car-prev">‹</button>
        <button class="car-btn car-next">›</button>
      </div>
      <p>تازه و خوش‌عطر. مناسب سس و سالاد.</p>
    </div>
  </div>
</section>

<!-- تبلیغات -->
<section class="block">
  <h2>📢 تبلیغات</h2>
  <div class="grid">
    <div class="block muted">محل نمایش تبلیغات محصولات کشاورزی و محلی شما</div>
  </div>
</section>

<!-- تماس با ما -->
<section class="block" id="contact">
  <h2>📞 تماس با ما</h2>
  <p>واتساپ: <a href="https://wa.me/989332356547">09332356547</a></p>
  <p>تلفن: 09332356547</p>
</section>

<!-- ناوبری پایین -->
<nav class="bottom-nav">
  <a class="nav-item" href="#home">🏠<span>خانه</span></a>
  <a class="nav-item" href="#products">🛒<span>محصولات</span></a>
  <a class="nav-item" href="#articles">📚<span>مقالات</span></a>
  <a class="nav-item" href="#contact">☎️<span>تماس</span></a>
</nav>

<button class="to-top" id="toTop" title="بازگشت به بالا">↑</button>

<footer>© مای‌ده — ساخته شده با عشق برای روستا 🌿</footer>

<script>
  /* =========================
     ابزارک‌های عمومی و ذخیره‌ها
  ==========================*/
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  // تم از LocalStorage
  const themeSelect = $('#themeSelect');
  const savedTheme = localStorage.getItem('mydeh-theme') || 'theme-green';
  document.body.className = savedTheme;
  themeSelect.value = savedTheme;
  themeSelect.addEventListener('change', () => {
    document.body.className = themeSelect.value;
    localStorage.setItem('mydeh-theme', themeSelect.value);
  });

  // شمارنده بازدید
  const pvKey = 'mydeh-pageviews';
  const views = Number(localStorage.getItem(pvKey) || 0) + 1;
  localStorage.setItem(pvKey, views);
  $('#pageViews').textContent = 'بازدید: ' + views.toLocaleString('fa-IR');

  // ساعت اهواز (Asia/Tehran)
  function refreshAhvazClock(){
    const now = new Date();
    const fmt = new Intl.DateTimeFormat('fa-IR', { timeZone:'Asia/Tehran', hour:'2-digit', minute:'2-digit' });
    const txt = fmt.format(now);
    $('#clockAhvaz').textContent = txt;
    $('#clockBtn').textContent = '⏰ ' + txt;
  }
  refreshAhvazClock();
  setInterval(refreshAhvazClock, 1000);

  // تاریخ امروز و نکته فصلی
  const today = new Date();
  $('#todayDate').textContent = new Intl.DateTimeFormat('fa-IR', { dateStyle:'full' }).format(today);
  const month = today.getMonth()+1; // 1..12
  const seasonalTips = {
    1:'دی/ژانویه: مراقب یخ‌زدگی جوانه‌ها باشید.',
    2:'بهمن/فوریه: زمان آماده‌سازی بذرها و خاک.',
    3:'اسفند/مارس: بهترین زمان شروع نشا.',
    4:'فروردین/آوریل: رشد پرقدرت؛ آبیاری منظم.',
    5:'اردیبهشت/مه: کنترل آفات به‌موقع.',
    6:'خرداد/ژوئن: گرما شروع می‌شود؛ مالچ فراموش نشود.',
    7:'تیر/ژوئیه: اوج گرما؛ سایه‌بان سبک و آبیاری صبح/غروب.',
    8:'مرداد/اوت: تغذیه پتاس برای میوه‌دهی بهتر.',
    9:'شهریور/سپتامبر: شروع کشت خیار؛ آماده برداشت‌های پاییزی.',
    10:'مهر/اکتبر: کشت پاییزی پیاز.',
    11:'آبان/نوامبر: مدیریت علف‌های هرز.',
    12:'آذر/دسامبر: تعمیرات آبیاری و آماده‌سازی فصل بعد.'
  };
  $('#seasonTip').textContent = seasonalTips[month] || 'نکته فصلی در دسترس نیست';

  /* =========================
     پنل سایدبار: علاقه‌مندی/اطلاعیه/هشدار
  ==========================*/
  const sidebar = $('#sidebar');
  $('#openSidebar').addEventListener('click', () => sidebar.classList.add('open'));
  $('#closeSidebar').addEventListener('click', () => sidebar.classList.remove('open'));

  // اطلاعیه‌ها (نمونه)
  const news = [
    '🧪 آزمایش خاک با تخفیف ویژه در هفته آینده.',
    '🚜 دوره کوتاه آبیاری هوشمند در مرکز جهاد کشاورزی.',
    '🧺 جمعه بازار محصولات محلی در روستای هدف.'
  ];
  const newsList = $('#newsList');
  news.forEach(n => {
    const li = document.createElement('li'); li.textContent = n; newsList.appendChild(li);
  });

  // هشدارها (دینامیک + نمونه)
  const alertList = $('#alertList');
  const alerts = [
    '🔥 گرمازدگی: در ساعات ظهر کار سنگین انجام نشود.',
    '🌬 باد: پوشش نهال‌ها را بررسی کنید.'
  ];
  function renderAlerts(){
    alertList.innerHTML = '';
    if(alerts.length===0){
      const li = document.createElement('li'); li.textContent = 'هشداری وجود ندارد'; alertList.appendChild(li);
    }else{
      alerts.forEach(a => { const li = document.createElement('li'); li.textContent = a; alertList.appendChild(li); });
    }
  }
  renderAlerts();

  /* =========================
     مقالات: باز/بسته + علاقه‌مندی
  ==========================*/
  const favKey = 'mydeh-favs';
  const favs = new Set(JSON.parse(localStorage.getItem(favKey) || '[]'));
  const favList = $('#favList');

  function renderFavs(){
    favList.innerHTML = '';
    if(favs.size===0){
      const li = document.createElement('li'); li.textContent = 'هنوز چیزی ستاره‌دار نشده'; favList.appendChild(li); return;
    }
    favs.forEach(id => {
      const art = document.querySelector(`.article[data-id="${id}"] h3`);
      const title = art ? art.textContent : id;
      const li = document.createElement('li'); li.textContent = '⭐ ' + title;
      favList.appendChild(li);
    });
  }

  $$('.article').forEach(card => {
    const star = card.querySelector('.star');
    const id = card.dataset.id;
    // حالت اولیه ستاره
    if(favs.has(id)){ star.classList.add('active'); star.textContent = '★'; }
    // کلیک روی عنوان: باز/بسته
    card.querySelector('h3').addEventListener('click', ()=> card.classList.toggle('open'));
    // کلیک روی ستاره
    star.addEventListener('click', (e)=>{
      e.stopPropagation();
      if(star.classList.toggle('active')){
        star.textContent = '★'; favs.add(id);
      }else{
        star.textContent = '☆'; favs.delete(id);
      }
      localStorage.setItem(favKey, JSON.stringify([...favs]));
      renderFavs();
    });
  });
  renderFavs();

  /* =========================
     جستجو در مقالات و محصولات
  ==========================*/
  function applySearch(q){
    const query = q.trim();
    const articleCards = $$('#articleGrid .article');
    const productCards = $$('#productGrid .product');

    const match = (el) => el.textContent.includes(query);

    articleCards.forEach(el => {
      el.style.display = (!query || match(el)) ? '' : 'none';
    });
    productCards.forEach(el => {
      el.style.display = (!query || match(el)) ? '' : 'none';
    });
  }
  $('#searchBtn').addEventListener('click', ()=> applySearch($('#searchInput').value));
  $('#clearSearch').addEventListener('click', ()=>{ $('#searchInput').value=''; applySearch(''); });

  /* =========================
     گالری محصولات (Carousel)
  ==========================*/
  $$('.carousel').forEach(car => {
    const slides = car.querySelector('.slides');
    const imgs = slides.querySelectorAll('img');
    const count = imgs.length;
    let idx = Number(car.dataset.index || 0);

    function render(){ slides.style.transform = `translateX(-${idx*100}%)`; car.dataset.index = idx; }
    car.querySelector('.car-prev').addEventListener('click', ()=>{ idx = (idx-1+count)%count; render(); });
    car.querySelector('.car-next').addEventListener('click', ()=>{ idx = (idx+1)%count; render(); });
    // اسکرول خودکار سبک
    setInterval(()=>{ idx = (idx+1)%count; render(); }, 5000);
    render();
  });

  /* =========================
     هواشناسی + هشدارهای خودکار
  ==========================*/
  const apiKey='dc9c93f51cdd375d459483c2a9f86d88';
  const weatherBox = $('#weatherResult');

  async function showWeatherFromURL(url){
    try{
      const res = await fetch(url);
      const data = await res.json();
      if(data.cod !== 200){ weatherBox.style.display='flex'; weatherBox.textContent='شهر یافت نشد'; return; }
      const dir = getWindDirection(data.wind.deg || 0);
      const icon = `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;
      weatherBox.innerHTML = `
        <img src="${icon}" alt="وضعیت">
        <div>
          <div><strong>${data.name}</strong> — ${data.weather[0].description}</div>
          <div>🌡 دما: ${Math.round(data.main.temp)}°C | 💧 رطوبت: ${data.main.humidity}%</div>
          <div>💨 باد: ${data.wind.speed} m/s (${dir}) | ☁ ابر: ${data.clouds?.all ?? 0}%</div>
        </div>
      `;
      weatherBox.style.display='flex';

      // تولید هشدار ساده از روی شرایط
      const t = data.main.temp, wind = data.wind.speed;
      const desc = (data.weather?.[0]?.main || '').toLowerCase();
      let newAlerts = [];
      if(t >= 42) newAlerts.push('🔥 هشدار گرما: در ساعات اوج، آبیاری به‌موقع و کار سبک انجام شود.');
      if(desc.includes('rain')) newAlerts.push('🌧 احتمال بارش: از شست‌وشوی خاک و بیماری‌های قارچی پیشگیری کنید.');
      if(wind >= 10) newAlerts.push('🌬 باد شدید: قیم نهال‌ها را محکم کنید.');
      // اضافه و رندر (بدون تکرار زیاد)
      newAlerts.forEach(a => { if(!alerts.includes(a)) alerts.push(a); });
      renderAlerts();
    }catch(e){
      weatherBox.style.display='flex';
      weatherBox.textContent='خطا در دریافت اطلاعات';
    }
  }

  function getWindDirection(deg){
    const dirs=["شمال","شمال‌شرقی","شرق","جنوب‌شرقی","جنوب","جنوب‌غربی","غرب","شمال‌غربی"];
    return dirs[Math.round(deg/45)%8];
  }

  $('#btnSearchWeather').addEventListener('click', ()=>{
    const city = $('#cityInput').value.trim();
    if(!city) return;
    const url=`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${apiKey}&units=metric&lang=fa`;
    showWeatherFromURL(url);
  });

  $('#btnMyLocation').addEventListener('click', ()=>{
    if(!navigator.geolocation){ weatherBox.style.display='flex'; weatherBox.textContent='GPS در مرورگر شما در دسترس نیست'; return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude:lat, longitude:lon} = pos.coords;
      const url=`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=fa`;
      showWeatherFromURL(url);
    }, ()=>{ weatherBox.style.display='flex'; weatherBox.textContent='دسترسی موقعیت رد شد'; });
  });

  /* =========================
     دکمه بازگشت به بالا
  ==========================*/
  const toTop = $('#toTop');
  window.addEventListener('scroll', ()=>{
    if(window.scrollY > 400){ toTop.classList.add('show'); } else { toTop.classList.remove('show'); }
  });
  toTop.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));

  /* =========================
     میان‌برهای مفید
  ==========================*/
  // باز/بسته شدن کارت‌ها با Enter
  $$('#articleGrid .article h3').forEach(h => {
    h.setAttribute('tabindex','0');
    h.addEventListener('keydown', e => { if(e.key==='Enter') h.click(); });
  });
</script>

</body>
</html>
